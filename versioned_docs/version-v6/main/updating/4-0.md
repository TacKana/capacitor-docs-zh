---
title: å‡çº§åˆ° 4.0
description: å°†åº”ç”¨ä¸­ Capacitor ä» v3 å‡çº§è‡³ v4 çš„æŒ‡å—
slug: /updating/4-0
---

# ä» Capacitor 3 å‡çº§åˆ° Capacitor 4

ç›¸è¾ƒäºä¹‹å‰çš„ç‰ˆæœ¬å‡çº§ï¼ŒCapacitor 3 åˆ° 4 çš„ç ´åæ€§å˜æ›´è¾ƒå°‘ã€‚æœ¬æŒ‡å—å°†æä¾›å‡çº§é¡¹ç›®è‡³ Capacitor 4 å½“å‰ç‰ˆæœ¬çš„æ­¥éª¤ï¼Œå¹¶åˆ—å‡ºå®˜æ–¹æ’ä»¶çš„ç ´åæ€§å˜æ›´åˆ—è¡¨ã€‚

## ä½¿ç”¨ CLI è¿›è¡Œè¿ç§»

é€šè¿‡ `npm i -D @capacitor/cli@latest-4` å®‰è£…æœ€æ–°ç‰ˆ Capacitor CLI åˆ°é¡¹ç›®ä¸­ã€‚å®‰è£…å®Œæˆåï¼Œè¿è¡Œ `npx cap migrate` å‘½ä»¤å³å¯è®© CLI è‡ªåŠ¨å¤„ç†è¿ç§»å·¥ä½œã€‚è‹¥æŸäº›è¿ç§»æ­¥éª¤æ— æ³•è‡ªåŠ¨å®Œæˆï¼Œç»ˆç«¯è¾“å‡ºä¸­ä¼šæä¾›é¢å¤–ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯æ‰‹åŠ¨è¿ç§»çš„å…·ä½“æ­¥éª¤ã€‚

## iOS å‡çº§æŒ‡å—

æœ¬éƒ¨åˆ†ä»‹ç»å¦‚ä½•å°† Capacitor 3 iOS é¡¹ç›®å‡çº§è‡³ Capacitor 4ã€‚

### æå‡ iOS éƒ¨ç½²ç›®æ ‡ç‰ˆæœ¬

åœ¨ Xcode é¡¹ç›®ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šåœ¨é¡¹ç›®ç¼–è¾‘å™¨ä¸­é€‰æ‹© **Project**ï¼Œæ‰“å¼€ **Build Settings** æ ‡ç­¾é¡µã€‚åœ¨ **Deployment** éƒ¨åˆ†å°† **iOS Deployment Target** ä¿®æ”¹ä¸º **iOS 13.0**ã€‚å¯¹æ‰€æœ‰çš„åº”ç”¨ **Targets** é‡å¤ç›¸åŒæ“ä½œã€‚

æ¥ç€æ‰“å¼€ `ios/App/Podfile` æ–‡ä»¶ï¼š
1. åœ¨ç¬¬ä¸€è¡Œæ·»åŠ ï¼š

```ruby
require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
```

2. å°† iOS ç‰ˆæœ¬æ›´æ–°è‡³ 13.0ï¼š

```ruby
platform :ios, '13.0'
```

3. åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

```ruby
post_install do |installer|
  assertDeploymentTarget(installer)
end
```

### ç§»é™¤åºŸå¼ƒä»£ç 

ä» `AppDelegate.swift` ä¸­ç§»é™¤ä¸å†éœ€è¦çš„ `touchesBegan` æ–¹æ³•ï¼š

```diff
-override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
-  super.touchesBegan(touches, with: event)
-
-  let statusBarRect = UIApplication.shared.statusBarFrame
-  guard let touchPoint = event?.allTouches?.first?.location(in: self.window) else { return }
-
-  if statusBarRect.contains(touchPoint) {
-      NotificationCenter.default.post(name: .capacitorStatusBarTapped, object: nil)
-  }
-}
```

### å¯é€‰ï¼šç§»é™¤ Info.plist ä¸­çš„ NSAppTransportSecurity æ¡ç›®

`NSAppTransportSecurity` ä»…ç”¨äºå®æ—¶é‡è½½åŠŸèƒ½ã€‚è‹¥æœªä½¿ç”¨å®æ—¶é‡è½½æˆ–ä½¿ç”¨ Ionic CLI å®ç°è¯¥åŠŸèƒ½ï¼Œå¯ç§»é™¤æ­¤é¡¹é…ç½®ï¼š

```diff
-<key>NSAppTransportSecurity</key>
-<dict>
-		  <key>NSAllowsArbitraryLoads</key>
-  		<true/>
-</dict>
```

## Android å‡çº§æŒ‡å—

æœ¬éƒ¨åˆ†ä»‹ç»å¦‚ä½•å°† Capacitor 3 Android é¡¹ç›®å‡çº§è‡³ Capacitor 4ã€‚

### æ›´æ–° Android é¡¹ç›®å˜é‡

åœ¨ `variables.gradle` æ–‡ä»¶ä¸­æ›´æ–°ä»¥ä¸‹æœ€ä½ç‰ˆæœ¬è¦æ±‚ï¼Œå¹¶æ–°å¢ `coreSplashScreenVersion` å’Œ `androidxWebkitVersion`ï¼š

```groovy
minSdkVersion = 22
compileSdkVersion = 32
targetSdkVersion = 32
androidxActivityVersion = '1.4.0'
androidxAppCompatVersion = '1.4.2'
androidxCoordinatorLayoutVersion = '1.2.0'
androidxCoreVersion = '1.8.0'
androidxFragmentVersion = '1.4.1'
coreSplashScreenVersion = '1.0.0-rc01'
androidxWebkitVersion = '1.4.0'
junitVersion = '4.13.2'
androidxJunitVersion = '1.1.3'
androidxEspressoCoreVersion = '3.4.0'
cordovaAndroidVersion = '10.1.1'
```

### åœ¨ Android Manifest ä¸­æ·»åŠ å¯¼å‡ºæ ‡è®°

åœ¨ `AndroidManifest.xml` æ–‡ä»¶çš„ `<activity>` æ ‡ç­¾ä¸­æ·»åŠ ï¼š

```xml
android:exported="true"
```

æ­¤æ ‡è®°ç¡®ä¿å¯ä»¥æ‰“å¼€åº”ç”¨ä¸­çš„"æ´»åŠ¨"ï¼ˆActivityï¼‰ã€‚æ›´å¤šä¿¡æ¯è¯·å‚é˜… [Android æ´»åŠ¨å…ƒç´ æ–‡æ¡£](https://developer.android.com/guide/topics/manifest/activity-element?hl=en)ã€‚

:::info
é»˜è®¤æƒ…å†µä¸‹ï¼Œ`AndroidManifest.xml` ä½äº `android/app/src/main/AndroidManifest.xml`ã€‚
:::

### æ›´æ–° Gradle Google Services æ’ä»¶

åœ¨ `android/build.gradle` ä¸­å°† `classpath 'com.google.gms:google-services:4.3.5'` æ›´æ–°ä¸º `classpath 'com.google.gms:google-services:4.3.13'`ã€‚

### å‡çº§è‡³ Gradle 7

åœ¨ `File > Project Structure > Project` ä¸­è°ƒæ•´ Gradle é¡¹ç›®è®¾ç½®ã€‚Android Gradle æ’ä»¶ç‰ˆæœ¬åº”ä¸ä½äº 7.2.1ï¼ŒGradle ç‰ˆæœ¬åº”ä¸ä½äº 7.4.2ã€‚åº”ç”¨æ›´æ”¹åï¼Œç‚¹å‡» Android Studio å³ä¸Šè§’çš„å¤§è±¡å›¾æ ‡æ‰§è¡Œ Gradle åŒæ­¥ã€‚

:::info
Android Studio å¯èƒ½æä¾›è‡ªåŠ¨å‡çº§è‡³ Gradle 7 çš„é€‰é¡¹ã€‚æ¥å—å»ºè®®å‡çº§å³å¯ï¼å‡çº§æ–¹å¼ï¼šæ‰“å¼€ `build.gradle` æ–‡ä»¶ï¼Œç‚¹å‡» ğŸ’¡ å›¾æ ‡é€‰æ‹© "Upgrade Gradle"ã€‚è¿ç§»å®ŒæˆåæŒ‰ä¸Šè¿°æ­¥éª¤æ‰§è¡Œ Gradle åŒæ­¥ã€‚

ä¹Ÿå¯ä½¿ç”¨ [Android Gradle æ’ä»¶å‡çº§åŠ©æ‰‹](https://developer.android.com/studio/build/agp-upgrade-assistant) å®Œæˆè¿ç§»ã€‚
:::

### ç¡®ä¿ä½¿ç”¨ Java 11

Capacitor 3 å…¼å®¹ Java 8 å’Œ 11ï¼Œè€Œ Capacitor 4 ä»…æ”¯æŒ Java 11ã€‚åœ¨ Android Studio ä¸­ä¿®æ”¹ï¼š

`Preferences > Build, Execution, Deployment > Build Tools > Gradle`

![Gradle é¦–é€‰é¡¹](/img/v6/docs/main/updating/android-java-11.png)

å°† "Gradle JDK" ä¿®æ”¹ä¸º Java 11ã€‚

:::info
æœ€æ–°ç‰ˆ Android Studio è‡ªå¸¦ Java 11ï¼Œæ— éœ€é¢å¤–ä¸‹è½½ï¼
:::

### å¯ç”¨ Android æ’ä»¶è‡ªåŠ¨åŠ è½½

è¿™æ˜¯ Capacitor 3 ä¸­çš„å¯é€‰åŠŸèƒ½ï¼Œåœ¨ Capacitor 4 ä¸­å˜ä¸ºå¼ºåˆ¶è¦æ±‚ï¼ˆinit æ–¹æ³•å·²è¢«ç§»é™¤ï¼‰ã€‚`MainActivity.java` ä¸­çš„ `onCreate` æ–¹æ³•å¯ä»¥ç§»é™¤ã€‚ç°åœ¨é€šè¿‡ npm å®‰è£…æˆ–ç§»é™¤æ’ä»¶æ—¶æ— éœ€å†ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚

```diff
 public class MainActivity extends BridgeActivity {
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-
-        // Initializes the Bridge
-        this.init(savedInstanceState, new ArrayList<Class<? extends Plugin>>() {{
-            // Additional plugins you've installed go here
-            add(Plugin1.class);
-            add(Plugin2.class);
-        }});
-    }
 }
```

### è°ƒæ•´æ’ä»¶æ³¨å†Œé¡ºåº

è‹¥åº”ç”¨åŒ…å«è‡ªå®šä¹‰æ’ä»¶ï¼Œéœ€åœ¨ `super.onCreate` å‰æ³¨å†Œï¼š

```diff
 public class MainActivity extends BridgeActivity {
     @Override
     public void onCreate(Bundle savedInstanceState) {
+        registerPlugin(PluginInMyApp.class);
         super.onCreate(savedInstanceState);
-        registerPlugin(PluginInMyApp.class);
     }
 }
```

### å¯é€‰ï¼šä½¿ç”¨ Android 12 å¯åŠ¨å±æ–° API

å¯ç”¨æ¨èçš„ [Android 12 å¯åŠ¨å± API](https://developer.android.com/guide/topics/ui/splash-screen)ï¼š

- åœ¨ `android/app/src/main/res/values/styles.xml` ä¸­ï¼Œå°† `AppTheme.NoActionBarLaunch` ä¸»é¢˜çš„ `parent` å±æ€§ä» `AppTheme.NoActionBar` æ”¹ä¸º `Theme.SplashScreen` å¹¶æ·»åŠ æ‰€éœ€é€‰é¡¹ï¼š

```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="android:background">@drawable/splash</item>
</style>
```

ä¸å¯ç”¨æ–° API ä¼šå¯¼è‡´ Android 12+ è®¾å¤‡å‡ºç°åŒé‡å¯åŠ¨å±ï¼Œæ—§è®¾å¤‡ä»ä½¿ç”¨ä¼ ç»Ÿå¯åŠ¨å±ã€‚

æ­¤å˜æ›´ä¸ºå¯é€‰ä½†å»ºè®®æ‰§è¡Œï¼Œå¦åˆ™ä¿®æ”¹å Android Studio ä¼šæ˜¾ç¤º `Cannot resolve symbol 'Theme.SplashScreen'` æç¤ºã€‚

- åœ¨ `android/app/build.gradle` çš„ä¾èµ–é¡¹ä¸­æ·»åŠ  `implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"`ã€‚

### å¯é€‰ï¼šä½¿ç”¨ DayNight ä¸»é¢˜

è¦å®ç°æ ¹æ®ç³»ç»Ÿä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢æ·±æµ…æ¨¡å¼ï¼Œå°† `android/app/src/main/res/values/styles.xml` ä¸­çš„ `<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">` æ”¹ä¸º `<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">`ã€‚

### å¯é€‰ï¼šä» Gradle æ–‡ä»¶ä¸­ç§»é™¤ jcenter()

ç”±äº Cordova å…¼å®¹å±‚ç°å·²æ‰˜ç®¡åœ¨ Maven Centralï¼Œå¯ç§»é™¤ `jcenter()`ã€‚è‹¥ä½¿ç”¨å…¶ä»–æ’ä»¶æˆ–åŸç”Ÿä¾èµ–ï¼Œè¯·ç¡®è®¤å®ƒä»¬ä¸ä¾èµ– Jcenter åå†ç§»é™¤ã€‚

## æ’ä»¶å˜æ›´

ä»¥ä¸‹æ’ä»¶åŠŸèƒ½å·²ä¿®æ”¹æˆ–ç§»é™¤ï¼Œè¯·ç›¸åº”è°ƒæ•´ä»£ç ã€‚

### å­˜å‚¨æ’ä»¶

`@capacitor/storage` æ’ä»¶æ›´åä¸º `@capacitor/preferences` ä»¥æ›´å‡†ç¡®åæ˜ ç”¨é€”ï¼ŒAPI ä¿æŒä¸å˜ã€‚

### ç›¸æœºæ’ä»¶

- ç§»é™¤ `preserveAspectRatio` è®¾ç½®
- ä¸å†æç¤ºç¼ºå¤± iOS ä½¿ç”¨æè¿°
- `androidxMaterialVersion` æ›´æ–°è‡³ `1.6.1`
- `androidxExifInterfaceVersion` æ›´æ–°è‡³ `1.3.3`

### æ“ä½œè¡¨æ’ä»¶

- `ShowActionsOptions.title` å˜ä¸ºå¯é€‰
- `androidxMaterialVersion` æ›´æ–°è‡³ `1.6.1`

#### iOS ä¸“å±å˜æ›´

- `buildActionSheet` çš„æ ‡é¢˜å’Œæ¶ˆæ¯å˜ä¸ºå¯é€‰

### æ¨é€é€šçŸ¥æ’ä»¶

- ä¸º `registrationError` äº‹ä»¶æ–°å¢ `RegistrationError` ç±»å‹
- `importance` å˜ä¸ºå¯é€‰ï¼Œé»˜è®¤å€¼ `3`
- `deleteChannel` ç°ä»…æ¥æ”¶é¢‘é“ ID è€Œéå®Œæ•´å¯¹è±¡
- `firebaseMessagingVersion` æ›´æ–°è‡³ `23.0.5`
- Android ç°éµå¾ª `presentationOptions` é…ç½®é€‰é¡¹

### æœ¬åœ°é€šçŸ¥æ’ä»¶

- `importance` å˜ä¸ºå¯é€‰ï¼Œé»˜è®¤å€¼ `3`
- `deleteChannel` ç°ä»…æ¥æ”¶é¢‘é“ ID è€Œéå®Œæ•´å¯¹è±¡
- Android 12+ éœ€è¦[ç²¾ç¡®é€šçŸ¥æƒé™](https://capacitorjs.com/docs/apis/local-notifications#android)

### åº”ç”¨æ’ä»¶

- `App.exitApp()` ç°åœ¨è¿”å› Promise

### åœ°ç†å®šä½æ’ä»¶

- `getCurrentPosition()` å¿½ç•¥è¶…æ—¶è®¾ç½®
- `playServicesLocationVersion` æ›´æ–°è‡³ `20.0.0`
- åº”ç”¨è¿›å…¥åå°æ—¶åœæ­¢ä½ç½®æ›´æ–°
- ç³»ç»Ÿå®šä½æœåŠ¡å…³é—­æ—¶æŠ›å‡ºé”™è¯¯

### æ–‡ä»¶ç³»ç»Ÿæ’ä»¶

- `copy` ç°åœ¨è¿”å›è¢«å¤åˆ¶æ–‡ä»¶çš„è·¯å¾„
- `ReaddirResult` ç°åœ¨è¿”å›åŒ…å«æ–‡ä»¶å…ƒæ•°æ®çš„ `FileInfo` å¯¹è±¡æ•°ç»„
- `StatResult` åœ¨å„å¹³å°è¿”å›ç»Ÿä¸€æ ¼å¼

### è®¾å¤‡æ’ä»¶

- iOS çš„ `model` ç°åœ¨è¿”å›ç²¾ç¡®å‹å·ï¼ˆå¦‚ä» "iPhone" å˜ä¸º "iPhone13.4"ï¼‰
- `getLanguageCode()` åœ¨ Web ç«¯è¿”å›ç®€å†™è¯­è¨€ä»£ç ï¼ˆä¸å…¶ä»–å¹³å°ä¸€è‡´ï¼‰ï¼Œè·å–å®Œæ•´ä»£ç è¯·ä½¿ç”¨ `getLanguageTag()`

### å¯¹è¯æ¡†æ’ä»¶

- `title` å˜ä¸ºå¯é€‰

### é”®ç›˜æ’ä»¶

- `style` é…ç½®é€‰é¡¹ç°åœ¨ä½¿ç”¨ `KeyboardStyle` æšä¸¾

###  toast æ’ä»¶

- Android 12 åŠä»¥ä¸Šç‰ˆæœ¬æ‰€æœ‰ toast æ˜¾ç¤ºåœ¨åº•éƒ¨

### æµè§ˆå™¨æ’ä»¶

- `androidxBrowserVersion` æ›´æ–°è‡³ `1.4.0`

### å¯åŠ¨å±æ’ä»¶

- è‹¥å¯ç”¨ Android 12 å¯åŠ¨å±æ–° APIï¼Œåˆå§‹å¯åŠ¨å±å¤§å¤šé…ç½®é€‰é¡¹ä¸å¯ç”¨ï¼ˆä½† `show()` è°ƒç”¨çš„å¯åŠ¨å±ä»å¯ç”¨ï¼‰
- Android 12+ è®¾å¤‡ä¸Šåˆå§‹å¯åŠ¨å±ä¸ `show()` æ˜¾ç¤ºçš„å¯åŠ¨å±ä¸åŒ