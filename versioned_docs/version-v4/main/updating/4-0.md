---
title: å‡çº§è‡³4.0ç‰ˆæœ¬
description: å°†åº”ç”¨ä¸­çš„Capacitorä»v3å‡çº§è‡³v4çš„æŒ‡å—
slug: /updating/4-0
---

# ä»Capacitor 3å‡çº§åˆ°Capacitor 4

ç›¸æ¯”ä¹‹å‰çš„ç‰ˆæœ¬å‡çº§ï¼ŒCapacitor 3åˆ°4çš„ç ´åæ€§å˜æ›´éå¸¸å°‘ã€‚æœ¬æŒ‡å—å°†ä¸ºæ‚¨æä¾›å‡çº§è‡³å½“å‰Capacitor 4ç‰ˆæœ¬çš„æ­¥éª¤ï¼Œä»¥åŠå®˜æ–¹æ’ä»¶çš„ç ´åæ€§å˜æ›´æ¸…å•ã€‚

## ä½¿ç”¨CLIè¿›è¡Œè¿ç§»

ä½¿ç”¨`npm i -D @capacitor/cli@latest-4`ä¸ºé¡¹ç›®å®‰è£…æœ€æ–°ç‰ˆCapacitor CLIã€‚å®‰è£…å®Œæˆåï¼Œåªéœ€è¿è¡Œ`npx cap migrate`å³å¯è®©CLIè‡ªåŠ¨å¤„ç†è¿ç§»ã€‚å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­æœ‰ä»»ä½•æ­¥éª¤æ— æ³•å®Œæˆï¼Œç»ˆç«¯è¾“å‡ºä¸­ä¼šæä¾›é¢å¤–ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯æ‰‹åŠ¨è¿ç§»çš„å…·ä½“æ­¥éª¤ã€‚

## iOSå¹³å°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†Capacitor 3çš„iOSé¡¹ç›®å‡çº§è‡³Capacitor 4ã€‚

### æé«˜iOSéƒ¨ç½²ç›®æ ‡

åœ¨Xcodeé¡¹ç›®ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šåœ¨é¡¹ç›®ç¼–è¾‘å™¨ä¸­é€‰ä¸­**Project**ï¼Œæ‰“å¼€**Build Settings**é€‰é¡¹å¡ã€‚åœ¨**Deployment**éƒ¨åˆ†ï¼Œå°†**iOS Deployment Target**ä¿®æ”¹ä¸º**iOS 13.0**ã€‚å¯¹æ‰€æœ‰åº”ç”¨**Targets**é‡å¤ç›¸åŒæ­¥éª¤ã€‚

ç„¶åæ‰“å¼€`ios/App/Podfile`å¹¶æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
1. åœ¨ç¬¬ä¸€è¡Œæ·»åŠ ï¼š

```ruby
require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
```

2. å°†iOSç‰ˆæœ¬æ›´æ–°è‡³13.0ï¼š

```ruby
platform :ios, '13.0'
```

3. åœ¨æœ€åä¸€è¡Œæ·»åŠ ï¼š

```ruby
post_install do |installer|
  assertDeploymentTarget(installer)
end
```

### ç§»é™¤å†—ä½™ä»£ç 

ä»`AppDelegate.swift`ä¸­ç§»é™¤æœªä½¿ç”¨çš„`touchesBegan`æ–¹æ³•ï¼š

```diff
-override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
-  super.touchesBegan(touches, with: event)
-
-  let statusBarRect = UIApplication.shared.statusBarFrame
-  guard let touchPoint = event?.allTouches?.first?.location(in: self.window) else { return }
-
-  if statusBarRect.contains(touchPoint) {
-      NotificationCenter.default.post(name: .capacitorStatusBarTapped, object: nil)
-  }
-}
```

### å¯é€‰ï¼šç§»é™¤Info.plistä¸­çš„NSAppTransportSecurityæ¡ç›®

`NSAppTransportSecurity`ä»…ç”¨äºå®æ—¶é‡è½½åŠŸèƒ½ï¼Œå¦‚æœæ‚¨ä¸ä½¿ç”¨å®æ—¶é‡è½½æˆ–ä½¿ç”¨Ionic CLIè¿›è¡Œå®æ—¶é‡è½½ï¼Œåˆ™ä¸å†éœ€è¦æ­¤é…ç½®ã€‚

```diff
-<key>NSAppTransportSecurity</key>
-<dict>
-		  <key>NSAllowsArbitraryLoads</key>
-  		<true/>
-</dict>
```

## Androidå¹³å°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•å°†Capacitor 3çš„Androidé¡¹ç›®å‡çº§è‡³Capacitor 4ã€‚

### æ›´æ–°Androidé¡¹ç›®å˜é‡

åœ¨`variables.gradle`æ–‡ä»¶ä¸­ï¼Œæ›´æ–°ä»¥ä¸‹æœ€ä½ç‰ˆæœ¬è¦æ±‚å¹¶æ–°å¢`coreSplashScreenVersion`å’Œ`androidxWebkitVersion`ï¼š

```groovy
minSdkVersion = 22
compileSdkVersion = 32
targetSdkVersion = 32
androidxActivityVersion = '1.4.0'
androidxAppCompatVersion = '1.4.2'
androidxCoordinatorLayoutVersion = '1.2.0'
androidxCoreVersion = '1.8.0'
androidxFragmentVersion = '1.4.1'
coreSplashScreenVersion = '1.0.0-rc01'
androidxWebkitVersion = '1.4.0'
junitVersion = '4.13.2'
androidxJunitVersion = '1.1.3'
androidxEspressoCoreVersion = '3.4.0'
cordovaAndroidVersion = '10.1.1'
```

### åœ¨Androidæ¸…å•ä¸­æ·»åŠ `android:exported`æ ‡ç­¾

åœ¨`AndroidManifest.xml`æ–‡ä»¶ä¸­ï¼Œéœ€è¦ä¸º`<activity>`æ ‡ç­¾æ·»åŠ ä»¥ä¸‹å±æ€§ï¼š

```xml
android:exported="true"
```

è¯¥æ ‡ç­¾ç¡®ä¿æ‚¨å¯ä»¥æ‰“å¼€åº”ç”¨ä¸­çš„"Activity"ï¼ˆå³å±å¹•ï¼‰ã€‚æœ‰å…³æ­¤æ ‡ç­¾åŠå…¶ä»–å±æ€§çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[Androidçš„`<activity>`å‚è€ƒæ–‡æ¡£](https://developer.android.com/guide/topics/manifest/activity-element?hl=en)ã€‚

:::æç¤º
é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨çš„`AndroidManifest.xml`æ–‡ä»¶ä½äº`android/app/src/main/AndroidManifest.xml`ã€‚
:::

### æ›´æ–°Gradle Google Servicesæ’ä»¶

åœ¨`android/build.gradle`æ–‡ä»¶ä¸­å°†`classpath 'com.google.gms:google-services:4.3.5'`æ›´æ–°ä¸º`classpath 'com.google.gms:google-services:4.3.13'`ã€‚

### å‡çº§è‡³Gradle 7

åœ¨`File > Project Structure > Project`ä¸­è°ƒæ•´Gradleé¡¹ç›®è®¾ç½®ã€‚Android Gradleæ’ä»¶ç‰ˆæœ¬åº”ä¸º7.2.1æˆ–æ›´é«˜ï¼ŒGradleç‰ˆæœ¬åº”ä¸º7.4.2æˆ–æ›´é«˜ã€‚åº”ç”¨æ›´æ”¹åï¼Œç‚¹å‡»Android Studioå³ä¸Šè§’çš„å¤§è±¡å›¾æ ‡æ‰§è¡ŒGradleåŒæ­¥ã€‚

:::æç¤º
Android Studioå¯èƒ½æä¾›è‡ªåŠ¨å‡çº§è‡³Gradle 7çš„é€‰é¡¹ã€‚å»ºè®®æ¥å—æ­¤å»ºè®®ï¼å‡çº§æ–¹æ³•ï¼šæ‰“å¼€`build.gradle`æ–‡ä»¶ï¼Œç‚¹å‡»ğŸ’¡å›¾æ ‡åé€‰æ‹©"Upgrade Gradle"ã€‚é¡¹ç›®è¿ç§»å®Œæˆåï¼ŒæŒ‰ä¸Šè¿°æ–¹æ³•æ‰§è¡ŒGradleåŒæ­¥ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨[Android Gradleæ’ä»¶å‡çº§åŠ©æ‰‹](https://developer.android.com/studio/build/agp-upgrade-assistant)è‡ªåŠ¨å®Œæˆè¿ç§»ã€‚
:::

### ç¡®ä¿ä½¿ç”¨Java 11

Capacitor 3æ”¯æŒJava 8å’ŒJava 11ï¼Œè€ŒCapacitor 4å°†ä»…æ”¯æŒJava 11ã€‚åœ¨Android Studioä¸­é€šè¿‡ä»¥ä¸‹èœå•ä¿®æ”¹é…ç½®ï¼š

`Preferences > Build, Execution, Deployment > Build Tools > Gradle`

![Gradleåå¥½è®¾ç½®](/img/v4/docs/main/updating/android-java-11.png)

åœ¨æ­¤å¤„å°†"Gradle JDK"ä¿®æ”¹ä¸ºJava 11ã€‚

:::æç¤º
Java 11å·²åŒ…å«åœ¨æœ€æ–°ç‰ˆAndroid Studioä¸­ï¼Œæ— éœ€é¢å¤–ä¸‹è½½ï¼
:::

### åˆ‡æ¢è‡³è‡ªåŠ¨åŠ è½½Androidæ’ä»¶

è¿™åœ¨Capacitor 3ä¸­æ˜¯å¯é€‰åŠŸèƒ½ï¼Œä½†ç”±äºç§»é™¤äº†initæ–¹æ³•ï¼ŒCapacitor 4å‡çº§åå˜ä¸ºå¼ºåˆ¶è¦æ±‚ã€‚åœ¨`MainActivity.java`ä¸­å¯ç§»é™¤`onCreate`æ–¹æ³•ã€‚ç°åœ¨é€šè¿‡npmå®‰è£…æˆ–ç§»é™¤æ’ä»¶æ—¶æ— éœ€å†ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚

```diff
 public class MainActivity extends BridgeActivity {
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-
-        // Initializes the Bridge
-        this.init(savedInstanceState, new ArrayList<Class<? extends Plugin>>() {{
-            // Additional plugins you've installed go here
-            add(Plugin1.class);
-            add(Plugin2.class);
-        }});
-    }
 }
```

### è°ƒæ•´æ’ä»¶æ³¨å†Œé¡ºåº

å¦‚æœåº”ç”¨åŒ…å«è‡ªå®šä¹‰æ’ä»¶ï¼Œéœ€åœ¨`super.onCreate`ä¹‹å‰æ³¨å†Œï¼š

```diff
 public class MainActivity extends BridgeActivity {
     @Override
     public void onCreate(Bundle savedInstanceState) {
+        registerPlugin(PluginInMyApp.class);
         super.onCreate(savedInstanceState);
-        registerPlugin(PluginInMyApp.class);
     }
 }
```

### å¯é€‰ï¼šä½¿ç”¨æ–°çš„Android 12å¯åŠ¨é¡µAPI

è¦å¯ç”¨æ¨èçš„[Android 12å¯åŠ¨é¡µAPI](https://developer.android.com/guide/topics/ui/splash-screen)ï¼Œéœ€è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

- åœ¨`android/app/src/main/res/values/styles.xml`ä¸­ï¼Œå°†`AppTheme.NoActionBarLaunch`ä¸»é¢˜çš„`parent`å±æ€§ä»`AppTheme.NoActionBar`æ”¹ä¸º`Theme.SplashScreen`ï¼Œå¹¶æ·»åŠ æ‰€éœ€é…ç½®é¡¹ï¼š

```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="android:background">@drawable/splash</item>
</style>
```

è‹¥ä¸å¯ç”¨Android 12å¯åŠ¨é¡µAPIï¼Œåœ¨Android 12+è®¾å¤‡ä¸Šä¼šå‡ºç°åŒå¯åŠ¨é¡µç°è±¡ï¼Œæ—§ç‰ˆè®¾å¤‡åˆ™ç»§ç»­ä½¿ç”¨ä¼ ç»Ÿå¯åŠ¨é¡µã€‚

æ­¤å˜æ›´è™½ä¸ºå¯é€‰ä½†å»ºè®®å®æ–½ï¼Œå¦åˆ™Android Studioä¼šæ˜¾ç¤º`Cannot resolve symbol 'Theme.SplashScreen'`æç¤ºã€‚

- åœ¨`android/app/build.gradle`çš„dependencieséƒ¨åˆ†æ·»åŠ ï¼š
`implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"`

### å¯é€‰ï¼šä½¿ç”¨DayNightä¸»é¢˜

è¦å®ç°æ ¹æ®è®¾å¤‡ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢ï¼ˆæ·±è‰²/æµ…è‰²ä¸»é¢˜ï¼‰ï¼Œåœ¨`android/app/src/main/res/values/styles.xml`ä¸­å°†`<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">`æ”¹ä¸º`<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">`ã€‚

### å¯é€‰ï¼šä»Gradleæ–‡ä»¶ä¸­ç§»é™¤`jcenter()`

ä»¥å¾€Capacitorç‰ˆæœ¬å› Cordovaå…¼å®¹å±‚æ‰˜ç®¡åœ¨Jcenterè€Œéœ€è¦æ­¤é…ç½®ã€‚ç°åœ¨æˆ‘ä»¬ä½¿ç”¨æ‰˜ç®¡åœ¨Maven Centralçš„æœ€æ–°ç‰ˆCordova Androidã€‚å¦‚æœå…¶ä»–æ’ä»¶æˆ–åŸç”Ÿä¾èµ–ä¸å†ä¾èµ–Jcenterï¼Œå¯ä»¥å®Œå…¨ç§»é™¤`jcenter()`é…ç½®ã€‚

## æ’ä»¶å˜æ›´

ä»¥ä¸‹æ’ä»¶åŠŸèƒ½å·²ä¿®æ”¹æˆ–ç§»é™¤ï¼Œè¯·ç›¸åº”è°ƒæ•´ä»£ç ã€‚

### å­˜å‚¨

`@capacitor/storage`æ’ä»¶å·²é‡å‘½åä¸º`@capacitor/preferences`ä»¥æ›´å‡†ç¡®åæ˜ ç”¨é€”ï¼ŒAPIä¿æŒä¸å˜ã€‚

### ç›¸æœº

- ç§»é™¤`preserveAspectRatio`é…ç½®é¡¹
- ä¸å†æç¤ºiOSä½¿ç”¨è¯´æ˜ç¼ºå¤±
- `androidxMaterialVersion`æ›´æ–°è‡³`1.6.1`
- `androidxExifInterfaceVersion`æ›´æ–°è‡³`1.3.3`

### æ“ä½œè¡¨

- `ShowActionsOptions.title`å˜ä¸ºå¯é€‰
- `androidxMaterialVersion`æ›´æ–°è‡³`1.6.1`

#### ä»…iOS

- `buildActionSheet`çš„æ ‡é¢˜å’Œæ¶ˆæ¯å˜ä¸ºå¯é€‰

### æ¨é€é€šçŸ¥

- ä¸º`registrationError`äº‹ä»¶æ–°å¢`RegistrationError`ç±»å‹
- `importance`å˜ä¸ºå¯é€‰ï¼Œé»˜è®¤ä¸º`3`
- `deleteChannel`ç°åœ¨ä»…æ¥æ”¶é¢‘é“IDè€Œéå®Œæ•´å¯¹è±¡
- `firebaseMessagingVersion`æ›´æ–°è‡³`23.0.5`
- Androidç°åœ¨æ”¯æŒ`presentationOptions`é…ç½®é¡¹

### æœ¬åœ°é€šçŸ¥

- `importance`å˜ä¸ºå¯é€‰ï¼Œé»˜è®¤ä¸º`3`
- `deleteChannel`ç°åœ¨ä»…æ¥æ”¶é¢‘é“IDè€Œéå®Œæ•´å¯¹è±¡
- Android 12+éœ€è¦[ç²¾ç¡®é€šçŸ¥æƒé™](https://capacitorjs.com/docs/apis/local-notifications#android)

### åº”ç”¨

- `App.exitApp()`ç°åœ¨è¿”å›Promise

### åœ°ç†ä½ç½®

- `getCurrentPosition()`çš„è¶…æ—¶è®¾ç½®å°†è¢«å¿½ç•¥
- `playServicesLocationVersion`æ›´æ–°è‡³`20.0.0`
- åº”ç”¨è¿›å…¥åå°æ—¶åœæ­¢ä½ç½®æ›´æ–°
- ç³»ç»Ÿå®šä½æœåŠ¡ç¦ç”¨æ—¶ä¼šæŠ›å‡ºé”™è¯¯

### æ–‡ä»¶ç³»ç»Ÿ

- `copy`ç°åœ¨è¿”å›è¢«å¤åˆ¶æ–‡ä»¶çš„è·¯å¾„
- `ReaddirResult`ç°åœ¨è¿”å›åŒ…å«å…ƒæ•°æ®çš„`FileInfo`å¯¹è±¡æ•°ç»„
- `StatResult`åœ¨å„å¹³å°è¿”å›ç»Ÿä¸€æ ¼å¼

### è®¾å¤‡

- iOSçš„`model`ç°åœ¨è¿”å›ç²¾ç¡®å‹å·ï¼ˆä»"iPhone"å˜ä¸º"iPhone13.4"ï¼‰
- `getLanguageCode()`åœ¨Webç«¯è¿”å›ç®€å†™è¯­è¨€ä»£ç ï¼ˆä¸å…¶ä»–å¹³å°ä¸€è‡´ï¼‰ï¼Œè·å–å®Œæ•´ä»£ç è¯·ä½¿ç”¨`getLanguageTag()`

### å¯¹è¯æ¡†

- `title`å˜ä¸ºå¯é€‰

### é”®ç›˜

- `style`é…ç½®é¡¹ç°åœ¨ä½¿ç”¨`KeyboardStyle`æšä¸¾

### åå¸

- Android 12åŠä»¥ä¸Šç‰ˆæœ¬æ‰€æœ‰åå¸æ˜¾ç¤ºåœ¨åº•éƒ¨

### æµè§ˆå™¨

- `androidxBrowserVersion`æ›´æ–°è‡³`1.4.0`

### å¯åŠ¨é¡µ

- è‹¥å¯ç”¨Android 12å¯åŠ¨é¡µAPIï¼Œå¤§å¤šæ•°é…ç½®é¡¹å¯¹åˆå§‹å¯åŠ¨é¡µæ— æ•ˆï¼ˆä»é€‚ç”¨äº`show()`è°ƒç”¨çš„å¯åŠ¨é¡µï¼‰ã€‚Android 12+è®¾å¤‡çš„åˆå§‹å¯åŠ¨é¡µä¸`show()`æ–¹æ³•çš„å¯åŠ¨é¡µä¸åŒã€‚