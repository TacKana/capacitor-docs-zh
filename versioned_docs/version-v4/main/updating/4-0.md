---
title: 升级至4.0版本
description: 将应用中的Capacitor从v3升级至v4的指南
slug: /updating/4-0
---

# 从Capacitor 3升级到Capacitor 4

相比之前的版本升级，Capacitor 3到4的破坏性变更非常少。本指南将为您提供升级至当前Capacitor 4版本的步骤，以及官方插件的破坏性变更清单。

## 使用CLI进行迁移

使用`npm i -D @capacitor/cli@latest-4`为项目安装最新版Capacitor CLI。安装完成后，只需运行`npx cap migrate`即可让CLI自动处理迁移。如果迁移过程中有任何步骤无法完成，终端输出中会提供额外信息。以下是手动迁移的具体步骤。

## iOS平台

本指南介绍如何将Capacitor 3的iOS项目升级至Capacitor 4。

### 提高iOS部署目标

在Xcode项目中执行以下操作：在项目编辑器中选中**Project**，打开**Build Settings**选项卡。在**Deployment**部分，将**iOS Deployment Target**修改为**iOS 13.0**。对所有应用**Targets**重复相同步骤。

然后打开`ios/App/Podfile`并按以下步骤操作：
1. 在第一行添加：

```ruby
require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
```

2. 将iOS版本更新至13.0：

```ruby
platform :ios, '13.0'
```

3. 在最后一行添加：

```ruby
post_install do |installer|
  assertDeploymentTarget(installer)
end
```

### 移除冗余代码

从`AppDelegate.swift`中移除未使用的`touchesBegan`方法：

```diff
-override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
-  super.touchesBegan(touches, with: event)
-
-  let statusBarRect = UIApplication.shared.statusBarFrame
-  guard let touchPoint = event?.allTouches?.first?.location(in: self.window) else { return }
-
-  if statusBarRect.contains(touchPoint) {
-      NotificationCenter.default.post(name: .capacitorStatusBarTapped, object: nil)
-  }
-}
```

### 可选：移除Info.plist中的NSAppTransportSecurity条目

`NSAppTransportSecurity`仅用于实时重载功能，如果您不使用实时重载或使用Ionic CLI进行实时重载，则不再需要此配置。

```diff
-<key>NSAppTransportSecurity</key>
-<dict>
-		  <key>NSAllowsArbitraryLoads</key>
-  		<true/>
-</dict>
```

## Android平台

本指南介绍如何将Capacitor 3的Android项目升级至Capacitor 4。

### 更新Android项目变量

在`variables.gradle`文件中，更新以下最低版本要求并新增`coreSplashScreenVersion`和`androidxWebkitVersion`：

```groovy
minSdkVersion = 22
compileSdkVersion = 32
targetSdkVersion = 32
androidxActivityVersion = '1.4.0'
androidxAppCompatVersion = '1.4.2'
androidxCoordinatorLayoutVersion = '1.2.0'
androidxCoreVersion = '1.8.0'
androidxFragmentVersion = '1.4.1'
coreSplashScreenVersion = '1.0.0-rc01'
androidxWebkitVersion = '1.4.0'
junitVersion = '4.13.2'
androidxJunitVersion = '1.1.3'
androidxEspressoCoreVersion = '3.4.0'
cordovaAndroidVersion = '10.1.1'
```

### 在Android清单中添加`android:exported`标签

在`AndroidManifest.xml`文件中，需要为`<activity>`标签添加以下属性：

```xml
android:exported="true"
```

该标签确保您可以打开应用中的"Activity"（即屏幕）。有关此标签及其他属性的更多信息，请参阅[Android的`<activity>`参考文档](https://developer.android.com/guide/topics/manifest/activity-element?hl=en)。

:::提示
默认情况下，您的`AndroidManifest.xml`文件位于`android/app/src/main/AndroidManifest.xml`。
:::

### 更新Gradle Google Services插件

在`android/build.gradle`文件中将`classpath 'com.google.gms:google-services:4.3.5'`更新为`classpath 'com.google.gms:google-services:4.3.13'`。

### 升级至Gradle 7

在`File > Project Structure > Project`中调整Gradle项目设置。Android Gradle插件版本应为7.2.1或更高，Gradle版本应为7.4.2或更高。应用更改后，点击Android Studio右上角的大象图标执行Gradle同步。

:::提示
Android Studio可能提供自动升级至Gradle 7的选项。建议接受此建议！升级方法：打开`build.gradle`文件，点击💡图标后选择"Upgrade Gradle"。项目迁移完成后，按上述方法执行Gradle同步。

另一种方法是使用[Android Gradle插件升级助手](https://developer.android.com/studio/build/agp-upgrade-assistant)自动完成迁移。
:::

### 确保使用Java 11

Capacitor 3支持Java 8和Java 11，而Capacitor 4将仅支持Java 11。在Android Studio中通过以下菜单修改配置：

`Preferences > Build, Execution, Deployment > Build Tools > Gradle`

![Gradle偏好设置](/img/v4/docs/main/updating/android-java-11.png)

在此处将"Gradle JDK"修改为Java 11。

:::提示
Java 11已包含在最新版Android Studio中，无需额外下载！
:::

### 切换至自动加载Android插件

这在Capacitor 3中是可选功能，但由于移除了init方法，Capacitor 4升级后变为强制要求。在`MainActivity.java`中可移除`onCreate`方法。现在通过npm安装或移除插件时无需再编辑此文件。

```diff
 public class MainActivity extends BridgeActivity {
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-
-        // Initializes the Bridge
-        this.init(savedInstanceState, new ArrayList<Class<? extends Plugin>>() {{
-            // Additional plugins you've installed go here
-            add(Plugin1.class);
-            add(Plugin2.class);
-        }});
-    }
 }
```

### 调整插件注册顺序

如果应用包含自定义插件，需在`super.onCreate`之前注册：

```diff
 public class MainActivity extends BridgeActivity {
     @Override
     public void onCreate(Bundle savedInstanceState) {
+        registerPlugin(PluginInMyApp.class);
         super.onCreate(savedInstanceState);
-        registerPlugin(PluginInMyApp.class);
     }
 }
```

### 可选：使用新的Android 12启动页API

要启用推荐的[Android 12启动页API](https://developer.android.com/guide/topics/ui/splash-screen)，需进行以下修改：

- 在`android/app/src/main/res/values/styles.xml`中，将`AppTheme.NoActionBarLaunch`主题的`parent`属性从`AppTheme.NoActionBar`改为`Theme.SplashScreen`，并添加所需配置项：

```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="android:background">@drawable/splash</item>
</style>
```

若不启用Android 12启动页API，在Android 12+设备上会出现双启动页现象，旧版设备则继续使用传统启动页。

此变更虽为可选但建议实施，否则Android Studio会显示`Cannot resolve symbol 'Theme.SplashScreen'`提示。

- 在`android/app/build.gradle`的dependencies部分添加：
`implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"`

### 可选：使用DayNight主题

要实现根据设备主题自动切换（深色/浅色主题），在`android/app/src/main/res/values/styles.xml`中将`<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">`改为`<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">`。

### 可选：从Gradle文件中移除`jcenter()`

以往Capacitor版本因Cordova兼容层托管在Jcenter而需要此配置。现在我们使用托管在Maven Central的最新版Cordova Android。如果其他插件或原生依赖不再依赖Jcenter，可以完全移除`jcenter()`配置。

## 插件变更

以下插件功能已修改或移除，请相应调整代码。

### 存储

`@capacitor/storage`插件已重命名为`@capacitor/preferences`以更准确反映用途，API保持不变。

### 相机

- 移除`preserveAspectRatio`配置项
- 不再提示iOS使用说明缺失
- `androidxMaterialVersion`更新至`1.6.1`
- `androidxExifInterfaceVersion`更新至`1.3.3`

### 操作表

- `ShowActionsOptions.title`变为可选
- `androidxMaterialVersion`更新至`1.6.1`

#### 仅iOS

- `buildActionSheet`的标题和消息变为可选

### 推送通知

- 为`registrationError`事件新增`RegistrationError`类型
- `importance`变为可选，默认为`3`
- `deleteChannel`现在仅接收频道ID而非完整对象
- `firebaseMessagingVersion`更新至`23.0.5`
- Android现在支持`presentationOptions`配置项

### 本地通知

- `importance`变为可选，默认为`3`
- `deleteChannel`现在仅接收频道ID而非完整对象
- Android 12+需要[精确通知权限](https://capacitorjs.com/docs/apis/local-notifications#android)

### 应用

- `App.exitApp()`现在返回Promise

### 地理位置

- `getCurrentPosition()`的超时设置将被忽略
- `playServicesLocationVersion`更新至`20.0.0`
- 应用进入后台时停止位置更新
- 系统定位服务禁用时会抛出错误

### 文件系统

- `copy`现在返回被复制文件的路径
- `ReaddirResult`现在返回包含元数据的`FileInfo`对象数组
- `StatResult`在各平台返回统一格式

### 设备

- iOS的`model`现在返回精确型号（从"iPhone"变为"iPhone13.4"）
- `getLanguageCode()`在Web端返回简写语言代码（与其他平台一致），获取完整代码请使用`getLanguageTag()`

### 对话框

- `title`变为可选

### 键盘

- `style`配置项现在使用`KeyboardStyle`枚举

### 吐司

- Android 12及以上版本所有吐司显示在底部

### 浏览器

- `androidxBrowserVersion`更新至`1.4.0`

### 启动页

- 若启用Android 12启动页API，大多数配置项对初始启动页无效（仍适用于`show()`调用的启动页）。Android 12+设备的初始启动页与`show()`方法的启动页不同。