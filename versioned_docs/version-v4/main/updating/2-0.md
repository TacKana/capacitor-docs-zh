---
title: 升级至2.0版本
description: 将应用中的Capacitor从v1升级至v2的指南
slug: /updating/2-0
---

# 将应用中的Capacitor升级至2.0

Capacitor 2带来了一些工具链更新，包括iOS平台采用Swift 5以及Android平台采用AndroidX支持库。

[阅读Capacitor 2.0发布公告 &#8250;](https://ionicframework.com/blog/announcing-capacitor-2-0)

## 更新Capacitor依赖

首先更新核心包和CLI工具：

```bash
npm install @capacitor/cli@2 @capacitor/core@2
```

然后更新使用的各平台包：

```bash
# iOS
npm install @capacitor/ios@2
npx cap sync ios

# Android
npm install @capacitor/android@2
npx cap sync android

# Electron
cd electron
npm install @capacitor/electron@2
```

## 不向后兼容的插件变更

- **相机插件**
  - 所有平台的`saveToGallery`参数默认值改为`false`
  - 当`allowEditing`为`true`且用户取消编辑时，将返回原始图片
- **推送通知**
  - 调用`register()`时不再自动请求权限，需使用`requestPermission()`
  - `PushNotificationChannel`重命名为`NotificationChannel`
- **本地通知**
  - 调用`register()`时不再自动请求权限，需使用`requestPermission()`
  - `schedule()`现在返回`LocalNotificationScheduleResult`对象
- **Toast**
  - 统一各平台显示时长：短提示2000毫秒，长提示3500毫秒
- **地理位置**
  - Android平台使用Fused Location Provider
  - 移除了`GeolocationOptions`中的`requireAltitude`参数
  - 调整了iOS原生定位精度值（[详情](https://github.com/ionic-team/capacitor/pull/2420)）
- **文件系统**
  - 移除了`MkdirOptions`中的`createIntermediateDirectories`参数（改用`recursive`）
  - 为`writeFile`添加`recursive`选项，改变了Android和Web平台的行为（[详情](https://github.com/ionic-team/capacitor/pull/2487)）
  - 移除了无效的`Application`目录选项
- **设备信息**
  - 从`getInfo()`移除了`batteryLevel`和`isCharging`，改用`getBatteryInfo()`
- **模态框**
  - `inputPlaceholder`现在设置占位文本而非默认值，如需默认值请用`inputText`
- **应用生命周期**
  - `AppRestoredResult`改为可选返回，仅在恢复成功时返回，否则返回错误
- **剪贴板**
  - 移除了`ReadOptions`配置项

## iOS平台

Capacitor 2要求Xcode 11及以上版本。

### 将原生项目升级至Swift 5

Capacitor 2使用Swift 5，建议将原生项目也升级至Swift 5：

1. 在Xcode中选择 **编辑** -> **转换** -> **转换为当前Swift语法**
1. 选中 **App.app** 后点击 **下一步**
1. 系统会提示 **无需源代码更改**
1. 最后点击 **更新** 按钮

## Android平台

### AndroidX支持库

Capacitor 2遵循Google建议使用AndroidX支持库，因此需要将原生项目也迁移至AndroidX。

在Android Studio中选择 **重构** -> **迁移至AndroidX**，点击 **迁移** 按钮后执行 **执行重构**。

如果使用了尚未支持AndroidX的Cordova或Capacitor插件，可以使用[jetifier](https://www.npmjs.com/package/jetifier)工具进行适配：

```bash
npm install jetifier
npx jetifier
```

如需在每次安装包后自动运行，可在`package.json`中添加`"postinstall": "jetifier"`。

### 创建公共变量配置

创建`android/variables.gradle`文件并填入以下内容：

```groovy
ext {
  minSdkVersion = 21
  compileSdkVersion = 29
  targetSdkVersion = 29
  androidxAppCompatVersion = '1.1.0'
  androidxCoreVersion =  '۱.۲.۰'
  androidxMaterialVersion =  '1.1.0-rc02'
  androidxBrowserVersion =  '1.2.0'
  androidxLocalbroadcastmanagerVersion =  '1.0.0'
  firebaseMessagingVersion =  '20.1.2'
  playServicesLocationVersion =  '17.0.0'
  junitVersion =  '4.12'
  androidxJunitVersion =  '1.1.1'
  androidxEspressoCoreVersion =  '3.2.0'
  cordovaAndroidVersion =  '7.0.0'
}
```

在`android/build.gradle`文件中添加引用：

```diff
         classpath 'com.android.tools.build:gradle:4.1.1'
         classpath 'com.google.gms:google-services:4.3.3'

         // NOTE: Do not place your application dependencies here; they belong
         // in the individual module build.gradle files
     }
 }

+apply from: "variables.gradle"

 allprojects {
     repositories {
         google()
         jcenter()
```

### 使用公共变量

创建变量文件后，更新项目配置以使用这些变量。

在`android/app/build.gradle`文件中进行以下修改：

```diff
 android {
-    compileSdkVersion 28
+    compileSdkVersion rootProject.ext.compileSdkVersion
     defaultConfig {
         applicationId "com.example.app"
-        minSdkVersion 21
-        targetSdkVersion 28
+        minSdkVersion rootProject.ext.minSdkVersion
+        targetSdkVersion rootProject.ext.targetSdkVersion
         versionCode 1
         versionName "1.0"
         testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
```

```diff
 dependencies {
     implementation fileTree(include: ['*.jar'], dir: 'libs')
-    implementation 'androidx.appcompat:appcompat:1.0.0'
+    implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
     implementation project(':capacitor-android')
-    testImplementation 'junit:junit:4.12'
-    androidTestImplementation 'androidx.test.ext:junit:1.1.1'
-    androidTestImplementation 'androidx.test.espresso:espresso-core:3.1.0'
+    testImplementation "junit:junit:$junitVersion"
+    androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
+    androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
     implementation project(':capacitor-cordova-android-plugins')
```

> 注意将单引号改为双引号，这是变量插值所必需的。

### 建议更新Android Studio插件

当在Android Studio中打开项目时，会出现 **插件更新建议** 提示。点击 **更新** 后按提示升级Gradle插件和Gradle版本。

也可手动更新：

1. 在`android/build.gradle`中将`com.android.tool.build:gradle`版本改为3.6.1
2. 在`android/gradle/wrapper/gradle-wrapper.properties`中将`gradle-4.10.1-all.zip`改为`gradle-5.6.4-all.zip`

### 更新Google Services插件

在`android/build.gradle`中将`com.google.gms:google-services`版本更新至4.3.3：

```diff
     dependencies {
         classpath 'com.android.tools.build:gradle:4.1.1'
-        classpath 'com.google.gms:google-services:۴.۲.۰'
+        classpath 'com.google.gms:google-services:4.3.3'

         // NOTE: Do not place your application dependencies here; they belong
         // in the individual module build.gradle files
     }
```

### 修改`android:configChanges`避免应用重启

在`android/app/src/main/AndroidManifest.xml`中扩展activity的配置变更参数：

```diff
         <activity
-            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale"
+            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode"
             android:name="com.example.app"
             android:label="@string/title_activity_main"
             android:theme="@style/AppTheme.NoActionBarLaunch"
             android:launchMode="singleTask">
```

### 在`FileProvider`中添加缓存目录路径

编辑`android/app/src/main/res/xml/file_paths.xml`添加缓存路径：

```diff
 <?xml version="1.0" encoding="utf-8"?>
 <paths xmlns:android="http://schemas.android.com/apk/res/android">
     <external-path name="my_images" path="." />
+    <cache-path name="my_cache_images" path="." />
 </paths>
```

### 移除`launch_splash.xml`

可以删除`android/app/src/main/res/drawable/launch_splash.xml`文件，该文件已不再使用。

### 移除maven仓库配置

Capacitor现已通过npm分发，移除`android/app/build.gradle`中不再需要的maven仓库配置：

```diff
 repositories {
-    maven {
-        url "https://dl.bintray.com/ionic-team/capacitor"
-    }
     flatDir {
         dirs '../capacitor-cordova-android-plugins/src/main/libs', 'libs'
     }
 }
```