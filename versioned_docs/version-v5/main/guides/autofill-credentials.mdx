---
title: Autofill Credentials
description: 自动填充凭证
contributors:
  - dtarnawsky
slug: /guides/autofill-credentials
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# 自动填充凭证
Android、iOS 和 Web 平台都内置了密码管理器，可以自动检测用户名和密码输入字段，并安全地存储和调用这些凭证。

为了让苹果和谷歌能自动填充和保存凭证，必须在您的网站和应用之间建立双向关联。本指南将沿用[深度链接](deep-links#create-site-association-file-1)的配置步骤，但会额外增加[Capacitor配置](#set-capacitor-server-hostname)和使用`autocomplete`属性的相关内容。

## 编写应用代码

您的应用需要为用户名和密码设置`ion-input`字段，且必须使用[`autocomplete`](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Attributes/autocomplete)属性。示例如下：

<Tabs groupId="framework" defaultValue="angular" values={[{ value: 'angular', label: 'Angular' }, { value: 'javascript', label: 'Javascript' }]}>
<TabItem value="angular">

```html
<form>
  <ion-list>
    <ion-item>
      <ion-label>电子邮箱</ion-label>
      <ion-input appAutofill type="email" name="email" autocomplete="email" [(ngModel)]="email" required email></ion-input>
    </ion-item>
    <ion-item>
      <ion-label>密码</ion-label>
      <ion-input appAutofill type="password" name="password" autocomplete="current-password" required [(ngModel)]="password"></ion-input>
    </ion-item>
  </ion-list>
  <ion-button type="submit">提交</ion-button>
</form>
```

由于`ion-input`存在与自动填充相关的[webkit bug](https://bugs.webkit.org/show_bug.cgi?id=226023)，您需要通过复制[此指令](https://gist.github.com/dtarnawsky/fc92869c1c67b9c74c66de8af3e081b2)到代码中来解决。

这个[示例应用](https://github.com/ionic-enterprise/cs-autofill-credendials)使用了本指南中的技术，实现了在iOS、Android和Web平台自动填充凭证的功能。
</TabItem>

<TabItem value="javascript">

```html
<form>
  <ion-list>
    <ion-item>
      <ion-label>电子邮箱</ion-label>
      <ion-input type="email" name="email" autocomplete="email" required email></ion-input>
    </ion-item>
    <ion-item>
      <ion-label>密码</ion-label>
      <ion-input id="pwd" type="password" name="password" autocomplete="current-password" required></ion-input>
    </ion-item>
  </ion-list>
  <ion-button type="submit">提交</ion-button>
</form>
```

由于`ion-input`存在与自动填充相关的[webkit bug](https://bugs.webkit.org/show_bug.cgi?id=226023)，您需要添加以下代码：
```javascript
    document.getElementById('pwd').children[0].addEventListener('change', (e) => {
      this.password = (e.target as any).value;      
    });
```
</TabItem>


</Tabs>

:::note
`autocomplete`属性支持自动填充多种凭证类型，如`username`、`current-pasword`、`new-password`。此外，无需额外配置也可用于电话号码、一次性验证码、信用卡信息等[更多场景](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Attributes/autocomplete)。
:::

## 配置Capacitor服务器主机名

默认情况下，Capacitor会使用`localhost`域名（iOS上是`capacitor://localhost`，Android上是`http://localhost`）。为了让密码管理器能为您的应用建议存储的凭证，您需要将配置从`localhost`改为`my-app.com`（与您应用关联的域名）。

可在`capacitor.config.ts`或`capacitor.config.json`文件中进行配置：
```typescript
const config: CapacitorConfig = {
...
  server: {
    hostname: 'my-app.com',
    androidScheme: 'https',
  }
};
```

## iOS配置

### XCode配置

在XCode中打开项目，导航至`Signing & Capabilities`。

![XCode功能界面](../../../../static/img/v5/docs/guides/autofill-credentials/xcode-capabilities.png)

- 点击`+`添加`Associated Domains`功能
- 在Domains部分点击`+`并添加条目`applinks:my-app.com`，其中`my-app.com`是您拥有并将创建应用关联文件的域名
- 确保启用了`Automatically manage signing`（否则需要在[Apple开发者门户](https://developer.apple.com/account/resources/identifiers/list)中配置App ID、功能和配置文件）

### 苹果应用站点关联文件

创建名为`apple-app-site-association`的站点关联文件，内容如下，将`TEAMID.BUNDLEID`替换为您自己的苹果团队ID和应用包ID（例如：`8L65AZE66A.com.company.myapp`）。

```json
{
  "applinks": {
    "details": [
      {
        "appID": "TEAMID.BUNDLEID",
        "paths": ["*"]
      }
    ]
  }
}
```

> 注意：虽然是JSON文件，但不要添加文件扩展名。

将该文件上传至您网站的`.well-known`目录（必须通过HTTPS托管）。
URL格式应为：`https://my-app.com/.well-known/apple-app-site-association`

### 验证

您可以在iOS设备上验证应用站点关联文件是否正确配置。

进入`设置` > `开发者` > `通用链接` -> `诊断工具`。输入URL（如`https://my-app.com`），将显示类似下方的验证结果：

![诊断结果](../../../../static/img/v5/docs/guides/autofill-credentials/diagnostics.png)

绿色对勾表示配置验证通过，黄色警告则存在问题。

#### 其他验证工具
苹果提供了[验证工具](https://search.developer.apple.com/appsearch-validation-tool/)，但有时会对有效配置也显示失败。

Branch提供的[工具](https://branch.io/resources/aasa-validator)可以验证链接、内容类型和JSON结构，但可能在无效JSON模式上显示假阳性。

### 保存凭证

要控制使用原生iOS密码管理器保存用户名和密码凭证，您需要使用[capacitor-ios-autofill-save-password](https://github.com/cuongpl/capacitor-ios-autofill-save-password)插件：
```bash
npm install capacitor-ios-autofill-save-password
```

针对iOS平台的代码需要在成功登录后保存凭证（其他平台无需此操作）：
```typescript
if (Capacitor.getPlatform() === 'ios') {
    await SavePassword.promptDialog({
        username: '[输入的用户名]',
        password: '[输入的密码]'
    });
}
```

当上述代码执行时，如果是保存新凭证或密码与设备上保存的不同，您将看到以下对话框。如果保存的凭证没有变化，则不会显示此对话框。

![保存凭证](../../../../static/img/v5/docs/guides/autofill-credentials/save-password.png)

### 自动填充实际效果
正确配置后，您的应用将显示如下辅助栏，展示域名和用户名。点击它将自动填充表单中的凭证。

如果只看到钥匙图标和"密码"文字，可能需要先保存第一组凭证，或者您的应用可能存在配置问题。

![自动填充凭证](../../../../static/img/v5/docs/guides/autofill-credentials/auto-fill.png)

## Android配置
遵循[Android深度链接指南](deep-links#android-configuration)创建站点关联文件和相关`AndroidManifest.xml`修改，并额外验证：
- 您的域名使用HTTPS并提供受信任的有效证书
- `capacitor.config.ts`中的`hostname`属性设置为您的域名（与`AndroidManifest.xml`中的`android:host`匹配），并使用`https`作为`androidScheme`：
```json
"server": {
    "androidScheme": "https",
    "hostname": "my-app.com"
}
```

## Web配置
如果针对Web平台，请遵循[深度链接指南](deep-links#website-configuration)。

如果在设备上安装了您的应用，当在iOS Safari中访问您的网站时，顶部会显示横幅提供打开应用的选项。如果想避免此行为，可以考虑为应用使用单独的子域名。

![iOS Safari](../../../../static/img/v5/docs/guides/autofill-credentials/ios-safari.png)

## iOS故障排除
有许多错误配置会导致应用无法在iOS上保存或调用凭证。

#### 密码的自动填充选项未显示。需要检查什么？

- Capacitor服务器主机名必须与网站域名匹配
- XCode中的包标识符必须与`apple-app-site-association`文件中的包标识符匹配
- `apple-app-site-association`文件中`AppID`前缀的团队标识符必须与苹果开发者账户中的团队标识符匹配
- XCode中关联域的前缀是`applinks:`
- XCode中的关联域必须与网站域名匹配
- `apple-app-site-association`文件必须通过HTTPS提供可信证书，不能使用HTTP或自签名证书
- 能在浏览器中访问`https://my-app.com/.well-known/apple-app-site-association`
- `apple-app-site-association`请求的响应返回的`content-type`为`application/json`
- `apple-app-site-association`文件没有使用文件扩展名
- `apple-app-site-association`文件已上传到名为`.well-known`的目录
- 没有为`apple-app-site-association`设置重定向
- 至少保存过一组凭证（如果从未提供过用户名或密码则无法自动填充）

:::warning
苹果通过其CDN检查`apple-app-site-association`文件，缓存时间最长可达一周。这意味着如果在初始检查时配置错误，即使您修正了问题也可能无法立即生效。同样，如果您将良好配置更改为错误配置，设备可能因缓存了域名与应用关联而仍显示功能正常。
:::

#### 是否需要`AutoFill Credential Provider`功能？
不需要，此功能非必需。

#### 关联域中是否需要`webcredentials:domain`？
不需要，只需在关联域中包含`applinks:domain`。

#### `apple-app-site-association`中是否需要`webcredentials`？
不需要，只需包含`applinks`和`appID`属性。

#### 苹果验证工具报告`Error cannot parse app site association`
即使您的应用能正常自动填充和保存凭证，苹果工具也可能报告错误。使用Branch的[替代工具](https://branch.io/resources/aasa-validator/)来验证您的苹果应用站点关联文件。

#### 苹果文档与本指南不符
苹果关于[关联域](https://developer.apple.com/documentation/xcode/supporting-associated-domains#Add-the-Associated-Domain-File-to-Your-Website)的文档展示的JSON示例包含名为`appIDs`（和`components`）的属性（这是一个数组），而本指南包含的是`appID`属性（和`paths`）。截至本文撰写时（2022年8月）和iOS 15.6测试，本文档是正确的，苹果文档中的JSON示例似乎有误。这可能是iOS的bug或文档错误。苹果在此处提供了一些[有效示例](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW1)。