---
title: 插件升级至5.0指南
description: 将插件中的Capacitor从早期版本升级到v5的指南
slug: /updating/plugins/5-0
---

# 代码中的重大变更

## iOS
### CAPBridgedProtocol协议变更

* `CAPBridgedPlugin`协议要求从类级别移至实例级别
* `pluginId`重命名为`identifier`以避免与`CAPPlugin.pluginId`冲突，同时移除了`getMethod(_:)`要求并将其转为内部扩展方法
* `pluginMethods`的类型也进行了明确化（从`Any`改为`CAPPluginMethod`）

绝大多数用户不会遇到问题，因为现有做法是使用宏来生成`CAPBridgedPlugin`的协议实现。只有那些手动实现`CAPBridgedPlugin`协议或进行类型转换的用户会受到影响。

## Android

### PluginCall.getObject() / PluginCall.getArray()

为了与iOS行为保持一致，Android上的`PluginCall.getObject()`和`PluginCall.getArray()`现在可能返回null。建议插件开发者在处理这些方法的返回值时进行null检查。

# 将插件中的Capacitor升级至5.0

## 使用@capacitor/plugin-migration-v4-to-v5

在插件目录下运行`npx @capacitor/plugin-migration-v4-to-v5@latest`，该工具会自动完成所有文件修改。

## 手动更新文件

### 更新package.json

将`@capacitor/cli`、`@capacitor/core`、`@capacitor/android`和`@capacitor/ios`更新到`latest-5`版本。

### 升级targetSDK/compileSDK至33
```diff
# build.gradle

android {
-    compileSdkVersion project.hasProperty('compileSdkVersion') ? rootProject.ext.compileSdkVersion : 32
+    compileSdkVersion project.hasProperty('compileSdkVersion') ? rootProject.ext.compileSdkVersion : 33
-    targetSdkVersion project.hasProperty('targetSdkVersion') ? rootProject.ext.targetSdkVersion : 32
+    targetSdkVersion project.hasProperty('targetSdkVersion') ? rootProject.ext.targetSdkVersion : 33
```

### 更新Android插件变量

在`build.gradle`中更新以下包的最低版本：

```diff
ext {
    junitVersion = project.hasProperty('junitVersion') ? rootProject.ext.junitVersion : '4.13.2'
-   androidxAppCompatVersion = project.hasProperty('androidxAppCompatVersion') ? rootProject.ext.androidxAppCompatVersion : '1.4.2'
+   androidxAppCompatVersion = project.hasProperty('androidxAppCompatVersion') ? rootProject.ext.androidxAppCompatVersion : '1.6.1'
-   androidxJunitVersion = project.hasProperty('androidxJunitVersion') ? rootProject.ext.androidxJunitVersion : '1.1.3'
+   androidxJunitVersion = project.hasProperty('androidxJunitVersion') ? rootProject.ext.androidxJunitVersion : '1.1.5'
-   androidxEspressoCoreVersion = project.hasProperty('androidxEspressoCoreVersion') ? rootProject.ext.androidxEspressoCoreVersion : '3.4.0'
+   androidxEspressoCoreVersion = project.hasProperty('androidxEspressoCoreVersion') ? rootProject.ext.androidxEspressoCoreVersion : '3.5.1'
```

### 升级gradle插件至8.0.0

```diff
    dependencies {
-       classpath 'com.android.tools.build:gradle:7.2.1'
+       classpath 'com.android.tools.build:gradle:8.0.0'
    }
```

### 升级gradle wrapper至8.0.2

```diff
# gradle-wrapper.properties

distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
- distributionUrl=https\://services.gradle.org/distributions/gradle-7.4.2-all.zip
+ distributionUrl=https\://services.gradle.org/distributions/gradle-8.0.2-all.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
```

### 将包声明移至build.gradle

```diff
# AndroidManifest.xml

<?xml version="1.0" encoding="utf-8"?>
- <manifest xmlns:android="http://schemas.android.com/apk/res/android"
-     package="[YOUR_PACKAGE_ID]">
+ <manifest xmlns:android="http://schemas.android.com/apk/res/android">
```

```diff
# build.gradle

android {
+     namespace "[YOUR_PACKAGE_ID]"
      compileSdkVersion project.hasProperty('compileSdkVersion') ? rootProject.ext.compileSdkVersion : 33
```

### 禁用Jetifier

```diff 
# gradle.properties

# Android operating system, and which are packaged with your app's APK
# https://developer.android.com/topic/libraries/support-library/androidx-rn
android.useAndroidX=true
- # Automatically convert third-party libraries to use AndroidX
- android.enableJetifier=true
```

### 升级至Java 17

```diff
# build.gradle
compileOptions {
-    sourceCompatibility JavaVersion.VERSION_11
+    sourceCompatibility JavaVersion.VERSION_17
-    targetCompatibility JavaVersion.VERSION_11
+    targetCompatibility JavaVersion.VERSION_17
}
```

### 更新kotlin_version

如果插件使用kotlin，更新默认的`kotlin_version`版本

```diff
# build.gradle
buildscript {
-    ext.kotlin_version = project.hasProperty("kotlin_version") ? rootProject.ext.kotlin_version : '1.7.0'
+    ext.kotlin_version = project.hasProperty("kotlin_version") ? rootProject.ext.kotlin_version : '1.8.20'
    repositories {
```

并将`org.jetbrains.kotlin:kotlin-stdlib-jdk7`或`org.jetbrains.kotlin:kotlin-stdlib-jdk8`依赖替换为`org.jetbrains.kotlin:kotlin-stdlib`。

```diff
# build.gradle
dependencies {
-    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
+    implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
```