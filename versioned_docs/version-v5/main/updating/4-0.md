---
title: å‡çº§è‡³4.0ç‰ˆæœ¬
description: å°†åº”ç”¨ä¸­çš„Capacitorä»v3å‡çº§è‡³v4çš„æŒ‡å—
slug: /updating/4-0
---

# ä»Capacitor 3å‡çº§åˆ°Capacitor 4

ç›¸è¾ƒäºä¹‹å‰çš„ç‰ˆæœ¬å‡çº§ï¼ŒCapacitor 3åˆ°4çš„ç ´åæ€§å˜æ›´ç›¸å½“æœ‰é™ã€‚æœ¬æŒ‡å—å°†æä¾›å‡çº§é¡¹ç›®è‡³å½“å‰Capacitor 4ç‰ˆæœ¬çš„æ­¥éª¤ï¼Œä»¥åŠæˆ‘ä»¬å®˜æ–¹æ’ä»¶çš„ç ´åæ€§å˜æ›´æ¸…å•ã€‚

## ä½¿ç”¨CLIè¿›è¡Œè¿ç§»

ä½¿ç”¨`npm i -D @capacitor/cli@latest-4`å°†æœ€æ–°ç‰ˆCapacitor CLIå®‰è£…åˆ°é¡¹ç›®ä¸­ã€‚å®‰è£…å®Œæˆåï¼Œåªéœ€è¿è¡Œ`npx cap migrate`å³å¯è®©CLIè‡ªåŠ¨å®Œæˆè¿ç§»ã€‚å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­æœ‰ä»»ä½•æ­¥éª¤æ— æ³•å®Œæˆï¼Œç»ˆç«¯è¾“å‡ºä¸­ä¼šæä¾›é™„åŠ ä¿¡æ¯ã€‚ä¸‹æ–¹åˆ—å‡ºäº†æ‰‹åŠ¨è¿ç§»çš„å…·ä½“æ­¥éª¤ã€‚

## iOSå¹³å°

ä»¥ä¸‹æŒ‡å—æè¿°å¦‚ä½•å°†Capacitor 3çš„iOSé¡¹ç›®å‡çº§åˆ°Capacitor 4ã€‚

### æå‡iOSéƒ¨ç½²ç›®æ ‡ç‰ˆæœ¬

åœ¨Xcodeé¡¹ç›®ä¸­æ“ä½œï¼šåœ¨é¡¹ç›®ç¼–è¾‘å™¨ä¸­é€‰æ‹©**Project**ï¼Œæ‰“å¼€**Build Settings**æ ‡ç­¾é¡µã€‚åœ¨**Deployment**éƒ¨åˆ†ï¼Œå°†**iOS Deployment Target**æ”¹ä¸º**iOS 13.0**ã€‚å¯¹æ‰€æœ‰çš„app **Targets**é‡å¤ç›¸åŒæ­¥éª¤ã€‚

ç„¶åï¼Œæ‰“å¼€`ios/App/Podfile`å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1. åœ¨ç¬¬ä¸€è¡Œæ·»åŠ ï¼š

```ruby
require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
```

2. å°†iOSç‰ˆæœ¬æ›´æ–°è‡³13.0ï¼š

```ruby
platform :ios, '13.0'
```

3. åœ¨æœ€åä¸€è¡Œæ·»åŠ ï¼š

```ruby
post_install do |installer|
  assertDeploymentTarget(installer)
end
```

### ç§»é™¤æ— ç”¨ä»£ç 

ä»`AppDelegate.swift`ä¸­ç§»é™¤æœªä½¿ç”¨çš„`touchesBegan`æ–¹æ³•

```diff
-override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
-  super.touchesBegan(touches, with: event)
-
-  let statusBarRect = UIApplication.shared.statusBarFrame
-  guard let touchPoint = event?.allTouches?.first?.location(in: self.window) else { return }
-
-  if statusBarRect.contains(touchPoint) {
-      NotificationCenter.default.post(name: .capacitorStatusBarTapped, object: nil)
-  }
-}
```

### å¯é€‰ï¼šä»Info.plistä¸­ç§»é™¤NSAppTransportSecurityæ¡ç›®

`NSAppTransportSecurity`ä»…ç”¨äºå®æ—¶é‡è½½åŠŸèƒ½ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨å®æ—¶é‡è½½æˆ–ä½¿ç”¨Ionic CLIè¿›è¡Œå®æ—¶é‡è½½ï¼Œåˆ™ä¸å†éœ€è¦æ­¤æ¡ç›®ã€‚

```diff
-<key>NSAppTransportSecurity</key>
-<dict>
-		  <key>NSAllowsArbitraryLoads</key>
-  		<true/>
-</dict>
```

## Androidå¹³å°

ä»¥ä¸‹æŒ‡å—æè¿°å¦‚ä½•å°†Capacitor 3çš„Androidé¡¹ç›®å‡çº§åˆ°Capacitor 4ã€‚

### æ›´æ–°Androidé¡¹ç›®å˜é‡

åœ¨`variables.gradle`æ–‡ä»¶ä¸­ï¼Œæ›´æ–°ä¸‹åˆ—å€¼ä¸ºæ–°è¦æ±‚çš„æœ€ä½ç‰ˆæœ¬ï¼Œå¹¶æ·»åŠ æ–°çš„`coreSplashScreenVersion`å’Œ`androidxWebkitVersion`

```groovy
minSdkVersion = 22
compileSdkVersion = 32
targetSdkVersion = 32
androidxActivityVersion = '1.4.0'
androidxAppCompatVersion = '1.4.2'
androidxCoordinatorLayoutVersion = '1.2.0'
androidxCoreVersion = '1.8.0'
androidxFragmentVersion = '1.4.1'
coreSplashScreenVersion = '1.0.0-rc01'
androidxWebkitVersion = '1.4.0'
junitVersion = '4.13.2'
androidxJunitVersion = '1.1.3'
androidxEspressoCoreVersion = '3.4.0'
cordovaAndroidVersion = '10.1.1'
```

### åœ¨Android Manifestä¸­æ·»åŠ `android:exported`æ ‡ç­¾

åœ¨`AndroidManifest.xml`æ–‡ä»¶ä¸­ï¼Œéœ€è¦åœ¨`<activity>`æ ‡ç­¾å†…æ·»åŠ ä»¥ä¸‹è¡Œï¼š

```xml
android:exported="true"
```

è¯¥æ ‡ç­¾ç¡®ä¿ä½ èƒ½æ‰“å¼€åº”ç”¨ä¸­çš„è¿™ä¸ª"Activity"ï¼ˆå³ç•Œé¢ï¼‰ã€‚äº†è§£æ›´å¤šå…³äºæ­¤æ ‡ç­¾åŠå…¶ä»–æ ‡ç­¾çš„ä¿¡æ¯ï¼Œè¯·æŸ¥é˜…[Androidçš„`<activity>`å‚è€ƒæ–‡æ¡£](https://developer.android.com/guide/topics/manifest/activity-element?hl=zh-cn)ã€‚

:::info
é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ çš„`AndroidManifest.xml`ä½äº`android/app/src/main/AndroidManifest.xml`ã€‚
:::

### æ›´æ–°Gradle Google Servicesæ’ä»¶

åœ¨`android/build.gradle`æ–‡ä»¶ä¸­ï¼Œå°†`classpath 'com.google.gms:google-services:4.3.5'`æ”¹ä¸º`classpath 'com.google.gms:google-services:4.3.13'`ä»¥æ›´æ–°Google Servicesæ’ä»¶ã€‚

### å‡çº§è‡³Gradle 7

åœ¨`File > Project Structure > Project`ä¸­è°ƒæ•´Gradleé¡¹ç›®è®¾ç½®ã€‚Android Gradleæ’ä»¶ç‰ˆæœ¬åº”ä¸ä½äº7.2.1ï¼ŒGradleç‰ˆæœ¬åº”ä¸ä½äº7.4.2ã€‚åº”ç”¨è¿™äº›æ›´æ”¹åï¼Œç‚¹å‡»Android Studioå³ä¸Šè§’çš„å¤§è±¡å›¾æ ‡æ‰§è¡ŒgradleåŒæ­¥ã€‚

:::info
Android Studioå¯èƒ½ä¼šæä¾›è‡ªåŠ¨è¿ç§»è‡³Gradle 7çš„é€‰é¡¹ã€‚æ”¾å¿ƒæ¥å—æ­¤å»ºè®®ï¼è¦å‡çº§ï¼Œè¯·æ‰“å¼€`build.gradle`æ–‡ä»¶ï¼Œç‚¹å‡»ğŸ’¡å›¾æ ‡ï¼Œé€‰æ‹©"Upgrade Gradle"ã€‚é¡¹ç›®è¿ç§»å®Œæˆåï¼ŒæŒ‰ä¸Šè¿°æ–¹æ³•æ‰§è¡ŒgradleåŒæ­¥ã€‚

å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨Android Gradleæ’ä»¶å‡çº§åŠ©æ‰‹æ¥å®Œæˆè¿ç§»ã€‚è¯¥å·¥å…·çš„æ“ä½œæ­¥éª¤å¯åœ¨[Androidæ–‡æ¡£](https://developer.android.com/studio/build/agp-upgrade-assistant)ä¸­æ‰¾åˆ°ã€‚
:::

### ç¡®ä¿ä½¿ç”¨Java 11

Capacitor 3å…¼å®¹Java 8å’Œ11ï¼Œä½†ä»Capacitor 4å¼€å§‹ä»…æ”¯æŒJava 11ã€‚åœ¨Android Studioä¸­æŒ‰ä»¥ä¸‹è·¯å¾„ä¿®æ”¹ï¼š

`Preferences > Build, Execution, Deployment > Build Tools > Gradle`

![Gradleåå¥½è®¾ç½®](/img/v5/docs/main/updating/android-java-11.png)

åœ¨æ­¤å¤„å°†"Gradle JDK"ä¿®æ”¹ä¸ºJava 11ã€‚

:::info
Java 11å·²éšæœ€æ–°ç‰ˆAndroid Studioä¸€åŒå‘å¸ƒï¼Œæ— éœ€é¢å¤–ä¸‹è½½ï¼
:::

### åˆ‡æ¢è‡³è‡ªåŠ¨Androidæ’ä»¶åŠ è½½

è¿™åœ¨Capacitor 3ä¸­æ˜¯å¯é€‰å˜æ›´ï¼Œä½†ç”±äºinitæ–¹æ³•å·²è¢«ç§»é™¤ï¼Œç°åœ¨å‡çº§Capacitor 4æ—¶å¿…é¡»æ‰§è¡Œã€‚åœ¨`MainActivity.java`ä¸­ï¼Œå¯ä»¥ç§»é™¤`onCreate`æ–¹æ³•ã€‚ä»Šåé€šè¿‡npmå®‰è£…æˆ–ç§»é™¤æ’ä»¶æ—¶ï¼Œéƒ½ä¸å†éœ€è¦ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚

```diff
 public class MainActivity extends BridgeActivity {
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-
-        // Initializes the Bridge
-        this.init(savedInstanceState, new ArrayList<Class<? extends Plugin>>() {{
-            // Additional plugins you've installed go here
-            add(Plugin1.class);
-            add(Plugin2.class);
-        }});
-    }
 }
```

### è°ƒæ•´æ’ä»¶æ³¨å†Œé¡ºåº

å¦‚æœåº”ç”¨åŒ…å«ä¸“é—¨ä¸ºä½ çš„åº”ç”¨æ„å»ºçš„è‡ªå®šä¹‰æ’ä»¶ï¼Œå¿…é¡»åœ¨`super.onCreate`ä¹‹å‰æ³¨å†Œå®ƒä»¬ï¼š

```diff
 public class MainActivity extends BridgeActivity {
     @Override
     public void onCreate(Bundle savedInstanceState) {
+        registerPlugin(PluginInMyApp.class);
         super.onCreate(savedInstanceState);
-        registerPlugin(PluginInMyApp.class);
     }
 }
```

### å¯é€‰ï¼šä½¿ç”¨æ–°çš„Android 12å¯åŠ¨ç”»é¢API

è¦å¯ç”¨æ¨èçš„**[Android 12å¯åŠ¨ç”»é¢API](https://developer.android.com/guide/topics/ui/splash-screen)**ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹æ›´æ”¹ï¼š

- åœ¨`android/app/src/main/res/values/styles.xml`ä¸­ï¼Œå°†`AppTheme.NoActionBarLaunch`ä¸»é¢˜çš„`parent`å±æ€§ä»`AppTheme.NoActionBar`æ”¹ä¸º`Theme.SplashScreen`ï¼Œå¹¶æ ¹æ®éœ€è¦ä¸ºä¸»é¢˜æ·»åŠ é€‰é¡¹ã€‚

```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="android:background">@drawable/splash</item>
</style>
```

è‹¥ä¸å¯ç”¨Android 12å¯åŠ¨ç”»é¢APIï¼Œåœ¨Android 12+è®¾å¤‡ä¸Šä¼šå‡ºç°åŒé‡å¯åŠ¨ç”»é¢ï¼Œæ—§ç‰ˆè®¾å¤‡åˆ™ä¼šä½¿ç”¨æ—§çš„å¯åŠ¨ç”»é¢ã€‚

æ­¤å˜æ›´æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®æ‰§è¡Œä»¥é¿å…Android Studioåœ¨æ‰§è¡Œä¸Šè¿°å˜æ›´åæ˜¾ç¤º`Cannot resolve symbol 'Theme.SplashScreen'`æ¶ˆæ¯ã€‚

- åœ¨`android/app/build.gradle`çš„dependencieséƒ¨åˆ†æ·»åŠ `implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"`ã€‚

### å¯é€‰ï¼šä½¿ç”¨DayNightä¸»é¢˜

è¦å®ç°åŸºäºç”¨æˆ·è®¾å¤‡ä¸»é¢˜ï¼ˆæ·±è‰²/æµ…è‰²ï¼‰çš„è‡ªåŠ¨ä¸»é¢˜åˆ‡æ¢ï¼Œå°†`android/app/src/main/res/values/styles.xml`ä¸­çš„`<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">`æ”¹ä¸º`<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">`ã€‚

### å¯é€‰ï¼šä»Gradleæ–‡ä»¶ä¸­ç§»é™¤`jcenter()`

åœ¨ä¹‹å‰çš„Capacitorç‰ˆæœ¬ä¸­ï¼Œç”±äºæˆ‘ä»¬çš„Cordovaå…¼å®¹å±‚æ‰˜ç®¡åœ¨Jcenterä¸Šï¼Œå¿…é¡»ä½¿ç”¨`jcenter()`ã€‚ä½†ç°åœ¨æˆ‘ä»¬ä½¿ç”¨äº†æ‰˜ç®¡åœ¨Maven Centralçš„æœ€æ–°ç‰ˆCordova Androidã€‚å› æ­¤ï¼Œä½ å¯ä»¥ä»`build.gradle`æ–‡ä»¶ä¸­å®Œå…¨ç§»é™¤`jcenter()`ã€‚å¦‚æœä½ ä½¿ç”¨å…¶ä»–æ’ä»¶æˆ–åŸç”Ÿä¾èµ–ï¼Œè¯·ç¡®ä¿å®ƒä»¬ä¸æ‰˜ç®¡åœ¨Jcenterä¸Šåå†ç§»é™¤ï¼

## æ’ä»¶

ä»¥ä¸‹æ’ä»¶åŠŸèƒ½å·²è¢«ä¿®æ”¹æˆ–ç§»é™¤ã€‚è¯·ç›¸åº”æ›´æ–°ä½ çš„ä»£ç ã€‚

### å­˜å‚¨

`@capacitor/storage`æ’ä»¶å·²æ›´åä¸º`@capacitor/preferences`ä»¥æ›´å‡†ç¡®åœ°åæ˜ å…¶ç”¨é€”ã€‚APIä¿æŒä¸å˜ã€‚

### ç›¸æœº

- ç§»é™¤äº†`preserveAspectRatio`è®¾ç½®
- æ’ä»¶ä¸å†æç¤ºiOSä½¿ç”¨æè¿°ç¼ºå¤±
- `androidxMaterialVersion`å˜é‡æ›´æ–°ä¸º`1.6.1`
- `androidxExifInterfaceVersion`å˜é‡æ›´æ–°ä¸º`1.3.3`

### åŠ¨ä½œè¡¨å•

- `ShowActionsOptions.title`ç°åœ¨å˜ä¸ºå¯é€‰
- `androidxMaterialVersion`å˜é‡æ›´æ–°ä¸º`1.6.1`

#### ä»…iOS

- `buildActionSheet`çš„æ ‡é¢˜å’Œæ¶ˆæ¯ç°åœ¨å˜ä¸ºå¯é€‰

### æ¨é€é€šçŸ¥ 

- ä¸º`registrationError`äº‹ä»¶æ–°å¢`RegistrationError`ç±»å‹
- `importance`ç°åœ¨å˜ä¸ºå¯é€‰ï¼Œé»˜è®¤ä¸º`3`
- `deleteChannel`ç°åœ¨ä»…æ¥æ”¶é¢‘é“IDè€Œéæ•´ä¸ªå¯¹è±¡
- `firebaseMessagingVersion`å˜é‡æ›´æ–°ä¸º`23.0.5`
- Androidç°åœ¨ä¼šéµå®ˆ`presentationOptions`é…ç½®é€‰é¡¹

### æœ¬åœ°é€šçŸ¥

- `importance`ç°åœ¨å˜ä¸ºå¯é€‰ï¼Œé»˜è®¤ä¸º`3`
- `deleteChannel`ç°åœ¨ä»…æ¥æ”¶é¢‘é“IDè€Œéæ•´ä¸ªå¯¹è±¡
- Android 12+éœ€è¦[ç‰¹å®šæƒé™](https://capacitorjs.com/docs/apis/local-notifications#android)æ¥å®ç°ç²¾ç¡®é€šçŸ¥

### åº”ç”¨

- `App.exitApp()`ç°åœ¨è¿”å›ä¸€ä¸ªPromise

### åœ°ç†ä½ç½®

- `getCurrentPosition()`ç°åœ¨å¿½ç•¥è¶…æ—¶è®¾ç½®
- `playServicesLocationVersion`æ›´æ–°ä¸º`20.0.0`
- å½“åº”ç”¨è¿›å…¥åå°çŠ¶æ€æ—¶ï¼Œæ’ä»¶ä¼šåœæ­¢ä½ç½®æ›´æ–°
- å¦‚æœç³»ç»Ÿå®šä½æœåŠ¡è¢«ç¦ç”¨ï¼Œæ’ä»¶ç°åœ¨ä¼šæŠ›å‡ºé”™è¯¯

### æ–‡ä»¶ç³»ç»Ÿ

- `copy`ç°åœ¨è¿”å›è¢«å¤åˆ¶æ–‡ä»¶çš„è·¯å¾„
- `ReaddirResult`ç°åœ¨è¿”å›`FileInfo`å¯¹è±¡æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªæ–‡ä»¶çš„URIåŠç›¸å…³å…ƒæ•°æ®
- `StatResult`å·²ç»Ÿä¸€ï¼Œåœ¨æ‰€æœ‰å¹³å°ä¸Šè¿”å›ç›¸åŒå†…å®¹

### è®¾å¤‡

- `model`åœ¨iOSä¸Šç°åœ¨è¿”å›ç²¾ç¡®å‹å·ï¼ˆä»"iPhone"å˜ä¸º"iPhone13.4"ï¼‰
- `getLanguageCode()`åœ¨webç«¯ç°åœ¨è¿”å›çŸ­è¯­è¨€ä»£ç ï¼ˆä¸å…¶ä»–å¹³å°ä¸€è‡´ï¼‰ï¼Œè¦è·å–å®Œæ•´ä»£ç è¯·ä½¿ç”¨`getLanguageTag()`

### å¯¹è¯æ¡†

- `title`ç°åœ¨å˜ä¸ºå¯é€‰

### é”®ç›˜

- `style`é…ç½®é€‰é¡¹ç°åœ¨ä½¿ç”¨`KeyboardStyle`æšä¸¾ä½œä¸ºé€‰é¡¹

### æç¤º

- åœ¨Android 12åŠæ›´æ–°ç‰ˆæœ¬ä¸Šï¼Œæ‰€æœ‰æç¤ºéƒ½æ˜¾ç¤ºåœ¨åº•éƒ¨

### æµè§ˆå™¨

- `androidxBrowserVersion`å˜é‡æ›´æ–°ä¸º`1.4.0`

### å¯åŠ¨ç”»é¢

- å¦‚æœåˆ‡æ¢åˆ°æ–°çš„Android 12å¯åŠ¨ç”»é¢APIï¼Œå¤§å¤šæ•°é…ç½®é€‰é¡¹å°†ä¸é€‚ç”¨äºåˆå§‹å¯åŠ¨ç”»é¢ï¼Œä½†è°ƒç”¨`show()`æ—¶æ˜¾ç¤ºçš„å¯åŠ¨ç”»é¢ä»å¯ç”¨è¿™äº›é€‰é¡¹ã€‚æ­¤å¤–ï¼Œåœ¨Android 12+è®¾å¤‡ä¸Šï¼Œåˆå§‹å¯åŠ¨ç”»é¢ä¸é€šè¿‡`show()`æ–¹æ³•æ˜¾ç¤ºçš„å¯åŠ¨ç”»é¢ä¸åŒã€‚