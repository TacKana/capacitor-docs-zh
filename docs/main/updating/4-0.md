---
title: å‡çº§è‡³ 4.0
description: å°†åº”ç”¨ä¸­çš„ Capacitor ä» v3 å‡çº§è‡³ v4 çš„æŒ‡å—
slug: /updating/4-0
---

# ä» Capacitor 3 å‡çº§è‡³ Capacitor 4

ç›¸è¾ƒäºä¹‹å‰çš„ç‰ˆæœ¬å‡çº§ï¼ŒCapacitor 3 å’Œ 4 ä¹‹é—´çš„é‡å¤§å˜æ›´ç›¸å¯¹è¾ƒå°‘ã€‚æœ¬æŒ‡å—å°†æä¾›å°†é¡¹ç›®å‡çº§åˆ°å½“å‰ Capacitor 4 ç‰ˆæœ¬çš„æ­¥éª¤ï¼Œä»¥åŠæˆ‘ä»¬å®˜æ–¹æ’ä»¶çš„é‡å¤§å˜æ›´åˆ—è¡¨ã€‚

## ä½¿ç”¨ CLI è¿›è¡Œè¿ç§»

é€šè¿‡ `npm i -D @capacitor/cli@latest-4` å®‰è£…æœ€æ–°ç‰ˆ Capacitor CLI åˆ°é¡¹ç›®ä¸­ã€‚å®‰è£…å®Œæˆåï¼Œåªéœ€è¿è¡Œ `npx cap migrate`ï¼ŒCLI å°†è‡ªåŠ¨å¤„ç†è¿ç§»å·¥ä½œã€‚å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­çš„ä»»ä½•æ­¥éª¤æ— æ³•å®Œæˆï¼Œç»ˆç«¯è¾“å‡ºä¸­ä¼šæä¾›é¢å¤–ä¿¡æ¯ã€‚ä»¥ä¸‹è¿˜åˆ—å‡ºäº†æ‰‹åŠ¨è¿ç§»çš„æ­¥éª¤ã€‚

## iOS å‡çº§æŒ‡å—

ä»¥ä¸‹æŒ‡å—æè¿°å¦‚ä½•å°† Capacitor 3 iOS é¡¹ç›®å‡çº§è‡³ Capacitor 4ã€‚

### æå‡ iOS éƒ¨ç½²ç›®æ ‡

åœ¨ Xcode é¡¹ç›®ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼šåœ¨é¡¹ç›®ç¼–è¾‘å™¨ä¸­é€‰æ‹© **Project** å¹¶æ‰“å¼€ **Build Settings** æ ‡ç­¾é¡µã€‚åœ¨ **Deployment** éƒ¨åˆ†ï¼Œå°† **iOS Deployment Target** æ”¹ä¸º **iOS 13.0**ã€‚å¯¹ä»»ä½•åº”ç”¨ **Targets** é‡å¤ç›¸åŒæ­¥éª¤ã€‚

ç„¶åï¼Œæ‰“å¼€ `ios/App/Podfile` å¹¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. åœ¨ç¬¬ä¸€è¡Œæ·»åŠ ï¼š

```ruby
require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
```

2. å°† iOS ç‰ˆæœ¬æ›´æ–°è‡³ 13.0ï¼š

```ruby
platform :ios, '13.0'
```

3. åœ¨æœ€åä¸€è¡Œæ·»åŠ ä»¥ä¸‹ä»£ç å—ï¼š

```ruby
post_install do |installer|
  assertDeploymentTarget(installer)
end
```

### ç§»é™¤ä¸éœ€è¦çš„ä»£ç 

ä» `AppDelegate.swift` ä¸­ç§»é™¤æœªä½¿ç”¨çš„ `touchesBegan` æ–¹æ³•

```diff
-override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
-  super.touchesBegan(touches, with: event)
-
-  let statusBarRect = UIApplication.shared.statusBarFrame
-  guard let touchPoint = event?.allTouches?.first?.location(in: self.window) else { return }
-
-  if statusBarRect.contains(touchPoint) {
-      NotificationCenter.default.post(name: .capacitorStatusBarTapped, object: nil)
-  }
-}
```

### å¯é€‰ï¼šä» Info.plist ä¸­ç§»é™¤ NSAppTransportSecurity æ¡ç›®

`NSAppTransportSecurity` ä»…ç”¨äºå®æ—¶é‡è½½ï¼ˆlive reloadï¼‰ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨å®æ—¶é‡è½½æˆ–ä½¿ç”¨ Ionic CLI è¿›è¡Œå®æ—¶é‡è½½ï¼Œå°±ä¸å†éœ€è¦æ­¤æ¡ç›®ã€‚

```diff
-<key>NSAppTransportSecurity</key>
-<dict>
-		  <key>NSAllowsArbitraryLoads</key>
-  		<true/>
-</dict>
```

## Android å‡çº§æŒ‡å—

ä»¥ä¸‹æŒ‡å—æè¿°å¦‚ä½•å°† Capacitor 3 Android é¡¹ç›®å‡çº§è‡³ Capacitor 4ã€‚

### æ›´æ–° Android é¡¹ç›®å˜é‡

åœ¨ `variables.gradle` æ–‡ä»¶ä¸­ï¼Œæ›´æ–°ä»¥ä¸‹å€¼ä¸ºæ–°çš„æœ€ä½è¦æ±‚ï¼Œå¹¶æ–°å¢ `coreSplashScreenVersion` å’Œ `androidxWebkitVersion`ï¼š

```groovy
minSdkVersion = 22
compileSdkVersion = 32
targetSdkVersion = 32
androidxActivityVersion = '1.4.0'
androidxAppCompatVersion = '1.4.2'
androidxCoordinatorLayoutVersion = '1.2.0'
androidxCoreVersion = '1.8.0'
androidxFragmentVersion = '1.4.1'
coreSplashScreenVersion = '1.0.0-rc01'
androidxWebkitVersion = '1.4.0'
junitVersion = '4.13.2'
androidxJunitVersion = '1.1.3'
androidxEspressoCoreVersion = '3.4.0'
cordovaAndroidVersion = '10.1.1'
```

### åœ¨ Android Manifest ä¸­æ·»åŠ  `android:exported` æ ‡ç­¾

åœ¨ `AndroidManifest.xml` æ–‡ä»¶ä¸­ï¼Œéœ€è¦åœ¨ `<activity>` æ ‡ç­¾ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š

```xml
android:exported="true"
```

æ­¤æ ‡ç­¾ç¡®ä¿ä½ å¯ä»¥æ‰“å¼€åº”ç”¨ä¸­çš„æ­¤"Activity"ï¼ˆå³å±å¹•ï¼‰ã€‚æƒ³äº†è§£æ›´å¤šå…³äºæ­¤æ ‡ç­¾åŠå…¶ä»–æ ‡ç­¾çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [Android `<activity>` å‚è€ƒæ–‡æ¡£](https://developer.android.com/guide/topics/manifest/activity-element?hl=en)ã€‚

:::info
é»˜è®¤æƒ…å†µä¸‹ï¼Œ`AndroidManifest.xml` ä½äº `android/app/src/main/AndroidManifest.xml`ã€‚
:::

### æ›´æ–° Gradle Google Services æ’ä»¶

åœ¨ `android/build.gradle` æ–‡ä»¶ä¸­ï¼Œå°† `classpath 'com.google.gms:google-services:4.3.5'` æ”¹ä¸º `classpath 'com.google.gms:google-services:4.3.13'` ä»¥æ›´æ–° Google Services æ’ä»¶ã€‚

### å‡çº§è‡³ Gradle 7

åœ¨ `File > Project Structure > Project` ä¸­è°ƒæ•´ Gradle é¡¹ç›®è®¾ç½®ã€‚Android Gradle æ’ä»¶ç‰ˆæœ¬åº”ä¸º 7.2.1 æˆ–æ›´é«˜ï¼ŒGradle ç‰ˆæœ¬åº”ä¸º 7.4.2 æˆ–æ›´é«˜ã€‚åº”ç”¨è¿™äº›æ›´æ”¹åï¼Œç‚¹å‡» Android Studio å³ä¸Šè§’çš„å¤§è±¡å›¾æ ‡æ‰§è¡Œ Gradle åŒæ­¥ã€‚

:::info
Android Studio å¯èƒ½ä¼šæä¾›è‡ªåŠ¨è¿ç§»è‡³ Gradle 7 çš„é€‰é¡¹ã€‚å¤§èƒ†æ¥å—å§ï¼å‡çº§æ—¶ï¼Œè¿›å…¥ `build.gradle` æ–‡ä»¶ï¼Œç‚¹å‡» ğŸ’¡ å›¾æ ‡ï¼Œç„¶åé€‰æ‹© "Upgrade Gradle"ã€‚é¡¹ç›®è¿ç§»å®Œæˆåï¼ŒæŒ‰ä¸Šè¿°æ–¹æ³•æ‰§è¡Œ Gradle åŒæ­¥ã€‚

å¦ä¸€ç§é€‰æ‹©æ˜¯ä½¿ç”¨ Android Gradle æ’ä»¶å‡çº§åŠ©æ‰‹æ¥å¤„ç†è¿ç§»ã€‚æ­¤å·¥å…·çš„æ­¥éª¤å¯åœ¨ [Android æ–‡æ¡£](https://developer.android.com/studio/build/agp-upgrade-assistant) ä¸­æ‰¾åˆ°ã€‚
:::

### ç¡®ä¿ä½¿ç”¨ Java 11

Capacitor 3 åŒæ—¶æ”¯æŒ Java 8 å’Œ Java 11ã€‚ä» Capacitor 4 å¼€å§‹ï¼Œä»…æ”¯æŒ Java 11ã€‚ä½ å¯ä»¥é€šè¿‡ Android Studio çš„ä»¥ä¸‹èœå•ä¿®æ”¹é¡¹ç›®è®¾ç½®ï¼š

`Preferences > Build, Execution, Deployment > Build Tools > Gradle`

![Gradle è®¾ç½®](/img/v6/docs/main/updating/android-java-11.png)

åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥å°† "Gradle JDK" ä¿®æ”¹ä¸º Java 11ã€‚

:::info
æœ€æ–°ç‰ˆ Android Studio è‡ªå¸¦ Java 11ï¼Œæ— éœ€é¢å¤–ä¸‹è½½ï¼
:::

### åˆ‡æ¢è‡³è‡ªåŠ¨ Android æ’ä»¶åŠ è½½

è¿™åœ¨ Capacitor 3 ä¸­æ˜¯å¯é€‰æ›´æ”¹ï¼Œä½†ç”±äº init æ–¹æ³•å·²è¢«ç§»é™¤ï¼Œç°åœ¨å‡çº§è‡³ Capacitor 4 æ—¶å˜ä¸ºå¼ºåˆ¶è¦æ±‚ã€‚åœ¨ `MainActivity.java` ä¸­ï¼Œå¯ä»¥ç§»é™¤ `onCreate` æ–¹æ³•ã€‚é€šè¿‡ npm å®‰è£…æˆ–ç§»é™¤æ’ä»¶æ—¶ï¼Œä½ ä¸å†éœ€è¦ç¼–è¾‘æ­¤æ–‡ä»¶ã€‚

```diff
 public class MainActivity extends BridgeActivity {
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-        super.onCreate(savedInstanceState);
-
-        // Initializes the Bridge
-        this.init(savedInstanceState, new ArrayList<Class<? extends Plugin>>() {{
-            // Additional plugins you've installed go here
-            add(Plugin1.class);
-            add(Plugin2.class);
-        }});
-    }
 }
```

### æ›´æ”¹ registerPlugin é¡ºåº

å¦‚æœä½ çš„åº”ç”¨åŒ…å«ä¸“ä¸ºåº”ç”¨æ„å»ºçš„è‡ªå®šä¹‰æ’ä»¶ï¼Œå¿…é¡»åœ¨ `super.onCreate` ä¹‹å‰æ³¨å†Œå®ƒä»¬ï¼š

```diff
 public class MainActivity extends BridgeActivity {
     @Override
     public void onCreate(Bundle savedInstanceState) {
+        registerPlugin(PluginInMyApp.class);
         super.onCreate(savedInstanceState);
-        registerPlugin(PluginInMyApp.class);
     }
 }
```

### å¯é€‰ï¼šä½¿ç”¨æ–°çš„ Android 12 å¯åŠ¨å± API

ä¸ºå¯ç”¨æ–°çš„æ¨è **[Android 12 å¯åŠ¨å± API](https://developer.android.com/guide/topics/ui/splash-screen)**ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹æ›´æ”¹ï¼š

- åœ¨ `android/app/src/main/res/values/styles.xml` ä¸­ï¼Œå°† `AppTheme.NoActionBarLaunch` ä¸»é¢˜çš„ `parent` å±æ€§ä» `AppTheme.NoActionBar` æ”¹ä¸º `Theme.SplashScreen`ï¼Œå¹¶æ ¹æ®éœ€è¦ä¸ºä¸»é¢˜æ·»åŠ é€‰é¡¹ã€‚

```xml
<style name="AppTheme.NoActionBarLaunch" parent="Theme.SplashScreen">
    <item name="android:background">@drawable/splash</item>
</style>
```

ä¸å¯ç”¨ Android 12 å¯åŠ¨å±å°†å¯¼è‡´ Android 12+ è®¾å¤‡ä¸Šå‡ºç°åŒå¯åŠ¨å±ï¼Œå¹¶åœ¨æ—§è®¾å¤‡ä¸Šä½¿ç”¨æ—§çš„å¯åŠ¨å±ã€‚

æ­¤æ›´æ”¹æ˜¯å¯é€‰çš„ï¼Œä½†ä¸ºé˜²æ­¢ Android Studio åœ¨æ›´æ”¹åæ˜¾ç¤º `Cannot resolve symbol 'Theme.SplashScreen'` æ¶ˆæ¯ï¼Œå»ºè®®è¿›è¡Œæ­¤æ›´æ”¹ã€‚

- åœ¨ `android/app/build.gradle` çš„ dependencies éƒ¨åˆ†æ·»åŠ  `implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"`ã€‚

### å¯é€‰ï¼šä½¿ç”¨ DayNight ä¸»é¢˜

è¦è®©åº”ç”¨æ ¹æ®ç”¨æˆ·è®¾å¤‡çš„ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢ï¼ˆæ·±è‰²/æµ…è‰²ä¸»é¢˜ï¼‰ï¼Œåœ¨ `android/app/src/main/res/values/styles.xml` ä¸­å°† `<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.NoActionBar">` æ”¹ä¸º `<style name="AppTheme.NoActionBar" parent="Theme.AppCompat.DayNight.NoActionBar">`ã€‚

### å¯é€‰ï¼šä» Gradle æ–‡ä»¶ä¸­ç§»é™¤ `jcenter()`

åœ¨ä¹‹å‰çš„ Capacitor ç‰ˆæœ¬ä¸­ï¼Œç”±äºæˆ‘ä»¬çš„ Cordova å…¼å®¹å±‚æ‰˜ç®¡åœ¨ Jcenter ä¸Šï¼Œéœ€è¦ `jcenter()`ã€‚ä½†ç°åœ¨æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ‰˜ç®¡åœ¨ Maven Central çš„æœ€æ–°ç‰ˆ Cordova Androidã€‚å› æ­¤ï¼Œä½ æˆ–è®¸å¯ä»¥å®Œå…¨ä» `build.gradle` æ–‡ä»¶ä¸­ç§»é™¤ `jcenter()`ã€‚å¦‚æœä½ ä½¿ç”¨å…¶ä»–æ’ä»¶æˆ–åŸç”Ÿä¾èµ–é¡¹ï¼Œç¡®ä¿å®ƒä»¬æ²¡æœ‰æ‰˜ç®¡åœ¨ Jcenter ä¸Šå†ç§»é™¤ï¼

## æ’ä»¶å˜æ›´

ä»¥ä¸‹æ’ä»¶åŠŸèƒ½å·²è¢«ä¿®æ”¹æˆ–ç§»é™¤ã€‚è¯·ç›¸åº”æ›´æ–°ä½ çš„ä»£ç ã€‚

### å­˜å‚¨

`@capacitor/storage` æ’ä»¶å·²æ›´åä¸º `@capacitor/preferences`ï¼Œä»¥æ›´å¥½åœ°åæ˜ å…¶ç”¨é€”ã€‚API ä¿æŒä¸å˜ã€‚

### ç›¸æœº

- ç§»é™¤äº† `preserveAspectRatio` è®¾ç½®
- æ’ä»¶ä¸å†æé†’ iOS ä½¿ç”¨è¯´æ˜ç¼ºå¤±
- `androidxMaterialVersion` å˜é‡æ›´æ–°è‡³ `1.6.1`
- `androidxExifInterfaceVersion` å˜é‡æ›´æ–°è‡³ `1.3.3`

### æ“ä½œè¡¨

- `ShowActionsOptions.title` æ”¹ä¸ºå¯é€‰
- `androidxMaterialVersion` å˜é‡æ›´æ–°è‡³ `1.6.1`

#### ä»… iOS

- `buildActionSheet` çš„æ ‡é¢˜å’Œæ¶ˆæ¯ç°åœ¨ä¸ºå¯é€‰

### æ¨é€é€šçŸ¥

- ä¸º `registrationError` äº‹ä»¶æ–°å¢äº† `RegistrationError` ç±»å‹
- `importance` ç°åœ¨ä¸ºå¯é€‰ï¼Œé»˜è®¤ä¸º `3`
- `deleteChannel` ç°åœ¨ä»…æ¥å—é¢‘é“ ID è€Œéæ•´ä¸ªå¯¹è±¡
- `firebaseMessagingVersion` å˜é‡æ›´æ–°è‡³ `23.0.5`
- Android ç°åœ¨éµå®ˆ `presentationOptions` é…ç½®é€‰é¡¹

### æœ¬åœ°é€šçŸ¥

- `importance` ç°åœ¨ä¸ºå¯é€‰ï¼Œé»˜è®¤ä¸º `3`
- `deleteChannel` ç°åœ¨ä»…æ¥å—é¢‘é“ ID è€Œéæ•´ä¸ªå¯¹è±¡
- Android 12+ éœ€è¦ [æƒé™](https://capacitorjs.com/docs/apis/local-notifications#android) æ¥å®ç°ç²¾ç¡®é€šçŸ¥

### åº”ç”¨

- `App.exitApp()` ç°åœ¨è¿”å›ä¸€ä¸ª Promise

### åœ°ç†ä½ç½®

- `getCurrentPosition()` ç°åœ¨å¿½ç•¥è¶…æ—¶
- `playServicesLocationVersion` æ›´æ–°è‡³ `20.0.0`
- å½“åº”ç”¨è¿›å…¥åå°çŠ¶æ€æ—¶ï¼Œæ’ä»¶ç°åœ¨ä¼šåœæ­¢ä½ç½®æ›´æ–°
- å¦‚æœç³»ç»Ÿå®šä½æœåŠ¡è¢«ç¦ç”¨ï¼Œæ’ä»¶ç°åœ¨ä¼šæŠ›å‡ºé”™è¯¯

### æ–‡ä»¶ç³»ç»Ÿ

- `copy` ç°åœ¨è¿”å›å¤åˆ¶æ–‡ä»¶çš„è·¯å¾„
- `ReaddirResult` ç°åœ¨è¿”å›ä¸€ä¸ª `FileInfo` å¯¹è±¡æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®åŠå…¶ URI
- `StatResult` å·²ç»Ÿä¸€ï¼Œåœ¨æ‰€æœ‰å¹³å°ä¸Šè¿”å›ç›¸åŒæ ¼å¼

### è®¾å¤‡

- `model` ç°åœ¨åœ¨ iOS ä¸Šè¿”å›ç²¾ç¡®å‹å·ï¼ˆä» "iPhone" æ”¹ä¸º "iPhone13.4"ï¼‰
- `getLanguageCode()` ç°åœ¨åœ¨ Web ä¸Šè¿”å›çŸ­è¯­è¨€ä»£ç ï¼ˆä¸å…¶ä»–å¹³å°ä¸€è‡´ï¼‰ï¼Œå¦‚éœ€å®Œæ•´ä»£ç è¯·ä½¿ç”¨ `getLanguageTag()`

### å¯¹è¯æ¡†

- `title` ç°åœ¨ä¸ºå¯é€‰

### é”®ç›˜

- `style` é…ç½®é€‰é¡¹ç°åœ¨ä½¿ç”¨ `KeyboardStyle` æšä¸¾

### é€šçŸ¥æç¤º

- åœ¨ Android 12 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šï¼Œæ‰€æœ‰æç¤ºéƒ½æ˜¾ç¤ºåœ¨åº•éƒ¨

### æµè§ˆå™¨

- `androidxBrowserVersion` å˜é‡æ›´æ–°è‡³ `1.4.0`

### å¯åŠ¨å±

- å¦‚æœåˆ‡æ¢åˆ°æ–°çš„ Android 12 å¯åŠ¨å± APIï¼Œå¤§å¤šæ•°é…ç½®é€‰é¡¹å°†ä¸é€‚ç”¨äºåˆå§‹å¯åŠ¨å±ï¼Œä½†åœ¨è°ƒç”¨ `show()` æ—¶ä»å¯ç”¨äºæ˜¾ç¤ºçš„å¯åŠ¨å±ã€‚æ­¤å¤–ï¼Œåœ¨ Android 12+ è®¾å¤‡ä¸Šï¼Œåˆå§‹å¯åŠ¨å±ä¸ `show()` æ–¹æ³•æ˜¾ç¤ºçš„å¯åŠ¨å±ä¸åŒã€‚